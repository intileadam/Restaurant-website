{% extends 'base.html' %}
{% block app_main_class %} app-main--wide{% endblock %}
{% block content %}
<section class="card customer-manager" data-customers-page>
  <header class="customer-manager__header">
    <div>
      <p class="eyebrow">Subscribers</p>
      <h2>Customer Directory</h2>
      <p class="muted">Click a row to preview details. Use the Edit button to update subscribers instantly.</p>
    </div>
    <div class="customer-manager__actions">
      <button type="button" class="btn ghost" data-manage-templates>
        <span>Manage Templates</span>
      </button>
      <button type="button" class="btn ghost" data-import-csv>
        <span>Import CSV</span>
      </button>
      <button type="button" class="btn ghost" data-clean-contacts>
        <span>Clean Contacts</span>
      </button>
      <button type="button" class="btn primary" data-add-customer>
        <span>+ Add customer</span>
      </button>
    </div>
  </header>

  <div class="customer-table-container">
    <div class="table-status" data-customers-loading>Loading customers…</div>
    <div class="table-status error" data-customers-error hidden>
      <div>
        <strong>Something went wrong.</strong>
        <p data-customers-error-message>Unable to load customers.</p>
      </div>
      <button type="button" class="btn ghost" data-reload-customers>Try again</button>
    </div>
    <div class="customer-table-shell" data-customers-shell hidden>
      <div class="customer-stats-bar" data-customers-stats hidden>
        <span class="customer-stat">
          <span class="customer-stat__label">Total customers</span>
          <span class="customer-stat__value" data-stat-total>0</span>
        </span>
        <span class="customer-stat-divider"></span>
        <span class="customer-stat">
          <span class="customer-stat__label">Subscribers</span>
          <span class="customer-stat__value" data-stat-subscribers>0</span>
        </span>
      </div>
      <div class="customer-table-toolbar">
        <label class="page-size-control">
          <span>Rows per page</span>
          <select data-customers-page-size>
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </label>
        <label class="page-size-control">
          <span>Subscription</span>
          <select data-customers-subscribed-filter>
            <option value="all" selected>All</option>
            <option value="subscribed">Subscribed</option>
            <option value="unsubscribed">Unsubscribed</option>
          </select>
        </label>
        <label class="customer-search-field">
          <span>Search</span>
          <input
            type="search"
            placeholder="Search by name, email, company, phone, or comments"
            data-customers-search
          />
        </label>
      </div>
      <div class="table-scroll">
        <table class="customer-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>First name</th>
              <th>Last name</th>
              <th>Company</th>
              <th>Phone</th>
              <th>Status</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody data-customers-body></tbody>
        </table>
        <div class="table-empty" data-customers-empty hidden>No customers yet.</div>
      </div>
      <div class="pagination-controls" data-pagination hidden>
        <button type="button" class="pager-button" data-pagination-prev>Prev</button>
        <div class="pagination-info" data-pagination-info></div>
        <button type="button" class="pager-button" data-pagination-next>Next</button>
      </div>
    </div>
  </div>
</section>

<div class="customer-modal-backdrop" data-customer-modal hidden>
  <div class="customer-modal" role="dialog" aria-modal="true" aria-labelledby="customerModalTitle">
    <header class="customer-modal__header">
      <div>
        <p class="eyebrow" data-modal-mode-label></p>
        <h3 id="customerModalTitle" data-modal-title></h3>
      </div>
      <button type="button" class="icon-button" aria-label="Close dialog" data-modal-close>&times;</button>
    </header>
    <div class="customer-modal__body">
      <div data-form-view>
        <form class="customer-form" data-customer-form>
          <div class="form-alert" data-form-alert hidden></div>
          <div class="form-grid">
            <label>
              <span>Email <span class="required">*</span></span>
              <input type="email" name="email" data-field-email required />
            </label>
            <label>
              <span>First name</span>
              <input type="text" name="firstname" data-field-firstname />
            </label>
            <label>
              <span>Last name</span>
              <input type="text" name="lastname" data-field-lastname />
            </label>
            <label>
              <span>Company</span>
              <input type="text" name="company" data-field-company />
            </label>
            <label>
              <span>Phone</span>
              <input type="text" name="phone" data-field-phone />
            </label>
            <label class="textarea-field">
              <span>Comments</span>
              <textarea name="comments" rows="3" data-field-comments></textarea>
            </label>
            <label class="checkbox-field">
              <input type="checkbox" name="is_subscribed" data-field-subscribed checked />
              <span>Subscribed</span>
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn danger" data-modal-delete hidden>Delete customer</button>
            <div class="form-actions__group">
              <button type="button" class="btn ghost" data-modal-cancel>Cancel</button>
              <button type="button" class="btn ghost" data-modal-send-email hidden disabled>Send email</button>
              <button type="submit" class="btn primary" data-modal-save>Save changes</button>
            </div>
          </div>
        </form>
      </div>
      <div class="individual-email-view" data-email-view hidden>
        <header class="individual-email-panel__header">
          <div>
            <p class="eyebrow">Individual email</p>
            <h3 data-email-recipient>Select recipient</h3>
            <p class="muted" data-email-recipient-note></p>
          </div>
        </header>
        <div class="individual-email-placeholder" data-email-placeholder>
          <p data-email-placeholder-text>
            Select a subscribed customer with an email address to send an individual message.
          </p>
        </div>
        <section class="individual-email-panel" data-email-panel hidden>
          <div class="individual-email-grid">
            <label>
              <span>Email template</span>
              <select data-email-template></select>
            </label>
            <label>
              <span>Subject</span>
              <input type="text" data-email-subject placeholder="Subject line" />
            </label>
          </div>
          <div class="individual-email-preview">
            <div class="preview-placeholder" data-email-preview-placeholder>
              Select a template to generate an email preview.
            </div>
            <iframe title="Individual email preview" loading="lazy" data-email-preview-frame hidden></iframe>
          </div>
          <div class="individual-email-actions">
            <button type="button" class="btn ghost" data-email-back>Cancel</button>
            <button type="button" class="btn primary" data-email-send>Send selected email</button>
          </div>
          <p class="form-status" data-email-status hidden></p>
        </section>
      </div>
    </div>
  </div>
</div>

<div class="customer-modal-backdrop" data-import-modal hidden>
  <div class="customer-modal import-modal" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
    <header class="customer-modal__header">
      <div>
        <p class="eyebrow">Bulk import</p>
        <h3 id="importModalTitle">Import customers from CSV</h3>
      </div>
      <button type="button" class="icon-button" aria-label="Close dialog" data-import-close>&times;</button>
    </header>
    <div class="customer-modal__body">
      <div data-import-form-view>
        <p class="import-instructions">
          Upload a <strong>.csv</strong> file with a header row. The <strong>email</strong> column is required.
          Optional columns: <code>firstname</code>, <code>lastname</code>, <code>company</code>, <code>phone</code>, <code>comments</code>.
        </p>
        <div class="import-file-area" data-import-drop-zone>
          <input type="file" accept=".csv" data-import-file hidden />
          <div class="import-file-placeholder" data-import-placeholder>
            <span class="import-file-icon">&#128196;</span>
            <p>Drag &amp; drop a CSV file here, or <button type="button" class="link-button" data-import-browse>browse</button></p>
          </div>
          <div class="import-file-selected" data-import-selected hidden>
            <span class="import-file-name" data-import-filename></span>
            <button type="button" class="link-button danger" data-import-clear>Remove</button>
          </div>
        </div>
        <div class="form-alert" data-import-alert hidden></div>
        <div class="form-actions">
          <div class="form-actions__group">
            <button type="button" class="btn ghost" data-import-cancel>Cancel</button>
            <button type="button" class="btn primary" data-import-upload disabled>Upload &amp; import</button>
          </div>
        </div>
      </div>
      <div data-import-results hidden>
        <div class="import-summary" data-import-summary></div>
        <div class="import-errors" data-import-errors hidden>
          <p class="import-errors__title">Skipped rows:</p>
          <ul data-import-error-list></ul>
        </div>
        <div class="form-actions">
          <div class="form-actions__group">
            <button type="button" class="btn primary" data-import-done>Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="customer-modal-backdrop" data-manage-templates-modal hidden>
  <div class="customer-modal manage-card" role="dialog" aria-modal="true" aria-labelledby="manageTemplatesTitle">
    <header class="customer-modal__header">
      <div>
        <p class="eyebrow">Email templates</p>
        <h3 id="manageTemplatesTitle">Manage individual email templates</h3>
      </div>
      <button type="button" class="icon-button" aria-label="Close dialog" data-manage-tpl-close>&times;</button>
    </header>
    <div class="customer-modal__body">
      <section class="manage-section">
        <h3 class="manage-section__title">Template files</h3>
        <p class="manage-section__lead">
          HTML files stored in <code>individual_emails/</code>. Delete any file you no longer need.
        </p>
        <div class="manage-file-list" data-manage-tpl-file-list>
          <p class="manage-file-list__loading">Loading...</p>
        </div>
        <p class="manage-status" data-manage-tpl-delete-status aria-live="polite" hidden></p>
      </section>

      <hr class="manage-divider" />

      <section class="manage-section">
        <h3 class="manage-section__title">Upload new template</h3>
        <form class="upload-card__form form-grid" data-manage-tpl-upload-form enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <label for="tpl_file">HTML file</label>
          <input type="file" id="tpl_file" name="template_file" accept=".html,text/html" required />

          <label for="tpl_filename">Save as (optional)</label>
          <input type="text" id="tpl_filename" name="filename" placeholder="welcome.html" inputmode="text" />

          <button type="submit" class="button secondary full-width">Upload HTML</button>
          <p class="manage-status" data-manage-tpl-upload-status aria-live="polite" hidden></p>
        </form>
      </section>
    </div>
  </div>
</div>

<div class="customer-modal-backdrop" data-clean-modal hidden>
  <div class="customer-modal clean-modal" role="dialog" aria-modal="true" aria-labelledby="cleanModalTitle">
    <header class="customer-modal__header">
      <div>
        <p class="eyebrow">Maintenance</p>
        <h3 id="cleanModalTitle">Clean Contacts</h3>
      </div>
      <button type="button" class="icon-button" aria-label="Close dialog" data-clean-close>&times;</button>
    </header>
    <div class="customer-modal__body">
      <div data-clean-scan-view>
        <p class="clean-description">
          Scan your contact list for <strong>duplicate email addresses</strong> and
          <strong>invalid emails</strong>. You can review and choose which records to keep
          before anything is deleted.
        </p>
        <div class="form-alert" data-clean-scan-alert hidden></div>
        <div class="form-actions">
          <div class="form-actions__group">
            <button type="button" class="btn ghost" data-clean-cancel>Cancel</button>
            <button type="button" class="btn primary" data-clean-scan-btn>Scan contacts</button>
          </div>
        </div>
      </div>

      <div data-clean-results-view hidden>
        <div class="clean-summary" data-clean-summary></div>

        <div data-clean-all-clear hidden>
          <p class="clean-all-clear-message">All contacts are clean &mdash; no duplicates or invalid emails found.</p>
        </div>

        <div data-clean-duplicates-section hidden>
          <h4 class="clean-section-title">Duplicate emails</h4>
          <p class="clean-section-lead">Select which record to <strong>keep</strong> for each duplicated email. The others will be removed.</p>
          <div class="clean-groups-scroll" data-clean-groups></div>
        </div>

        <div data-clean-invalid-section hidden>
          <h4 class="clean-section-title">Invalid emails</h4>
          <p class="clean-section-lead">The following contacts have malformed email addresses. Check the ones you want to <strong>delete</strong>.</p>
          <div class="clean-invalid-scroll" data-clean-invalid-list></div>
        </div>

        <div class="form-alert" data-clean-exec-alert hidden></div>
        <div class="form-actions">
          <div class="form-actions__group">
            <button type="button" class="btn ghost" data-clean-results-cancel>Cancel</button>
            <button type="button" class="btn danger" data-clean-exec-btn disabled>Clean contacts</button>
          </div>
        </div>
      </div>

      <div data-clean-done-view hidden>
        <div class="clean-done-summary" data-clean-done-summary></div>
        <div class="form-actions">
          <div class="form-actions__group">
            <button type="button" class="btn primary" data-clean-done-btn>Done</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const root = document.querySelector("[data-customers-page]");
    if (!root) return;

    const elements = {
      tableBody: root.querySelector("[data-customers-body]"),
      shell: root.querySelector("[data-customers-shell]"),
      loading: root.querySelector("[data-customers-loading]"),
      error: root.querySelector("[data-customers-error]"),
      errorMessage: root.querySelector("[data-customers-error-message]"),
      empty: root.querySelector("[data-customers-empty]"),
      reloadBtn: root.querySelector("[data-reload-customers]"),
      addBtn: root.querySelector("[data-add-customer]"),
      container: root.querySelector(".customer-table-container"),
      modal: document.querySelector("[data-customer-modal]"),
      formView: document.querySelector("[data-form-view]"),
      emailView: document.querySelector("[data-email-view]"),
      form: document.querySelector("[data-customer-form]"),
      alert: document.querySelector("[data-form-alert]"),
      modeLabel: document.querySelector("[data-modal-mode-label]"),
      modalTitle: document.querySelector("[data-modal-title]"),
      saveBtn: document.querySelector("[data-modal-save]"),
      cancelBtn: document.querySelector("[data-modal-cancel]"),
      closeBtn: document.querySelector("[data-modal-close]"),
      deleteBtn: document.querySelector("[data-modal-delete]"),
      sendEmailBtn: document.querySelector("[data-modal-send-email]"),
      statsBar: root.querySelector("[data-customers-stats]"),
      statTotal: root.querySelector("[data-stat-total]"),
      statSubscribers: root.querySelector("[data-stat-subscribers]"),
      searchInput: root.querySelector("[data-customers-search]"),
      pageSizeSelect: root.querySelector("[data-customers-page-size]"),
      subscribedFilterSelect: root.querySelector("[data-customers-subscribed-filter]"),
      pagination: root.querySelector("[data-pagination]"),
      paginationInfo: root.querySelector("[data-pagination-info]"),
      prevBtn: root.querySelector("[data-pagination-prev]"),
      nextBtn: root.querySelector("[data-pagination-next]"),
      emailPanel: document.querySelector("[data-email-panel]"),
      emailPlaceholder: document.querySelector("[data-email-placeholder]"),
      emailPlaceholderText: document.querySelector("[data-email-placeholder-text]"),
      emailTemplateSelect: document.querySelector("[data-email-template]"),
      emailSubjectInput: document.querySelector("[data-email-subject]"),
      emailPreviewFrame: document.querySelector("[data-email-preview-frame]"),
      emailPreviewPlaceholder: document.querySelector("[data-email-preview-placeholder]"),
      emailSendBtn: document.querySelector("[data-email-send]"),
      emailStatus: document.querySelector("[data-email-status]"),
      emailRecipient: document.querySelector("[data-email-recipient]"),
      emailRecipientNote: document.querySelector("[data-email-recipient-note]"),
      emailBackBtns: document.querySelectorAll("[data-email-back]"),
      importBtn: root.querySelector("[data-import-csv]"),
      importModal: document.querySelector("[data-import-modal]"),
      importClose: document.querySelector("[data-import-close]"),
      importCancel: document.querySelector("[data-import-cancel]"),
      importFileInput: document.querySelector("[data-import-file]"),
      importDropZone: document.querySelector("[data-import-drop-zone]"),
      importBrowse: document.querySelector("[data-import-browse]"),
      importPlaceholder: document.querySelector("[data-import-placeholder]"),
      importSelected: document.querySelector("[data-import-selected]"),
      importFilename: document.querySelector("[data-import-filename]"),
      importClear: document.querySelector("[data-import-clear]"),
      importAlert: document.querySelector("[data-import-alert]"),
      importUpload: document.querySelector("[data-import-upload]"),
      importFormView: document.querySelector("[data-import-form-view]"),
      importResults: document.querySelector("[data-import-results]"),
      importSummary: document.querySelector("[data-import-summary]"),
      importErrors: document.querySelector("[data-import-errors]"),
      importErrorList: document.querySelector("[data-import-error-list]"),
      importDone: document.querySelector("[data-import-done]"),
      manageTplBtn: root.querySelector("[data-manage-templates]"),
      manageTplModal: document.querySelector("[data-manage-templates-modal]"),
      manageTplClose: document.querySelector("[data-manage-tpl-close]"),
      manageTplFileList: document.querySelector("[data-manage-tpl-file-list]"),
      manageTplDeleteStatus: document.querySelector("[data-manage-tpl-delete-status]"),
      manageTplUploadForm: document.querySelector("[data-manage-tpl-upload-form]"),
      manageTplUploadStatus: document.querySelector("[data-manage-tpl-upload-status]"),
      cleanBtn: root.querySelector("[data-clean-contacts]"),
      cleanModal: document.querySelector("[data-clean-modal]"),
      cleanClose: document.querySelector("[data-clean-close]"),
      cleanCancel: document.querySelector("[data-clean-cancel]"),
      cleanScanView: document.querySelector("[data-clean-scan-view]"),
      cleanScanAlert: document.querySelector("[data-clean-scan-alert]"),
      cleanScanBtn: document.querySelector("[data-clean-scan-btn]"),
      cleanResultsView: document.querySelector("[data-clean-results-view]"),
      cleanSummary: document.querySelector("[data-clean-summary]"),
      cleanAllClear: document.querySelector("[data-clean-all-clear]"),
      cleanDuplicatesSection: document.querySelector("[data-clean-duplicates-section]"),
      cleanGroups: document.querySelector("[data-clean-groups]"),
      cleanInvalidSection: document.querySelector("[data-clean-invalid-section]"),
      cleanInvalidList: document.querySelector("[data-clean-invalid-list]"),
      cleanExecAlert: document.querySelector("[data-clean-exec-alert]"),
      cleanExecBtn: document.querySelector("[data-clean-exec-btn]"),
      cleanResultsCancel: document.querySelector("[data-clean-results-cancel]"),
      cleanDoneView: document.querySelector("[data-clean-done-view]"),
      cleanDoneSummary: document.querySelector("[data-clean-done-summary]"),
      cleanDoneBtn: document.querySelector("[data-clean-done-btn]"),
    };

    if (!elements.tableBody || !elements.modal || !elements.form) return;

    const defaultEmptyMessage = elements.empty ? elements.empty.textContent : "No customers yet.";
    const defaultEmailPlaceholderText = elements.emailPlaceholderText
      ? elements.emailPlaceholderText.textContent.trim()
      : "Select a subscribed customer with an email address to send an individual message.";
    const SEARCH_DELAY = 300;
    let searchTimer;
    let emailTemplatesPromise = null;

    const state = {
      customers: [],
      mode: "create",
      activeId: null,
      currentCustomer: null,
      page: 1,
      perPage: Number(elements.pageSizeSelect?.value) || 25,
      totalPages: 1,
      totalCount: 0,
      search: elements.searchInput ? elements.searchInput.value.trim() : "",
      subscribedFilter: elements.subscribedFilterSelect ? elements.subscribedFilterSelect.value : "all",
      emailTemplates: [],
      activeEmailTemplate: "",
      emailSubjectTouched: false,
      emailPreviewToken: 0,
      emailCustomerId: null,
      viewMode: "form",
    };

    function authorizedFetch(input, init = {}) {
      const headers = new Headers(init.headers || {});
      const csrfToken = window.getCsrfToken ? window.getCsrfToken() : "";
      if (csrfToken && !headers.has("X-CSRF-Token")) {
        headers.set("X-CSRF-Token", csrfToken);
      }
      return fetch(input, { credentials: "same-origin", ...init, headers });
    }

    function setModalView(mode) {
      state.viewMode = mode;
      if (elements.modal) {
        elements.modal.classList.toggle("email-mode", mode === "email");
      }
      if (elements.formView) {
        elements.formView.hidden = mode !== "form";
      }
      if (elements.emailView) {
        elements.emailView.hidden = mode !== "email";
      }
    }

    function setLoading(isLoading) {
      if (elements.loading) {
        elements.loading.hidden = !isLoading;
      }
      if (elements.container) {
        elements.container.classList.toggle("is-loading", isLoading);
      }
    }

    function showError(message) {
      if (!elements.error || !elements.errorMessage || !elements.shell) return;
      elements.error.hidden = false;
      elements.errorMessage.textContent = message;
      elements.shell.hidden = true;
    }

    function hideError() {
      if (!elements.error || !elements.shell) return;
      elements.error.hidden = true;
      elements.shell.hidden = false;
    }

    function renderCustomers() {
      elements.tableBody.innerHTML = "";
      if (!state.customers.length) {
        elements.empty.hidden = false;
        elements.empty.textContent = state.search ? "No matching customers." : defaultEmptyMessage;
        return;
      }
      elements.empty.hidden = true;
      elements.empty.textContent = defaultEmptyMessage;

      const fragment = document.createDocumentFragment();
      state.customers.forEach((customer) => {
        const row = document.createElement("tr");
        row.dataset.id = customer.id;

        function addCell(text) {
          const td = document.createElement("td");
          td.textContent = text || "";
          row.appendChild(td);
        }

        addCell(customer.email);
        addCell(customer.firstname || "—");
        addCell(customer.lastname || "—");
        addCell(customer.company || "—");
        addCell(customer.phone || "—");

        const statusTd = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = customer.is_subscribed ? "status-pill success" : "status-pill muted";
        pill.textContent = customer.is_subscribed ? "Subscribed" : "Unsubscribed";
        statusTd.appendChild(pill);
        row.appendChild(statusTd);

        const commentsTd = document.createElement("td");
        const comments = customer.comments || "";
        commentsTd.textContent = comments ? truncate(comments) : "—";
        commentsTd.title = comments;
        row.appendChild(commentsTd);

        fragment.appendChild(row);
      });

      elements.tableBody.appendChild(fragment);
    }

    function renderStats(stats) {
      if (!elements.statsBar || !stats) return;
      if (elements.statTotal) {
        elements.statTotal.textContent = Number(stats.total_customers).toLocaleString();
      }
      if (elements.statSubscribers) {
        elements.statSubscribers.textContent = Number(stats.total_subscribers).toLocaleString();
      }
      elements.statsBar.hidden = false;
    }

    function renderPagination() {
      if (!elements.pagination) return;
      const total = state.totalCount || 0;
      const totalPages = Math.max(1, state.totalPages || 1);
      const shouldShow = total > state.perPage;
      elements.pagination.hidden = !shouldShow;

      if (elements.paginationInfo) {
        elements.paginationInfo.textContent = shouldShow
          ? `Page ${state.page} of ${totalPages} · ${total} total`
          : "";
      }

      if (elements.prevBtn) {
        elements.prevBtn.disabled = state.page <= 1;
      }
      if (elements.nextBtn) {
        elements.nextBtn.disabled = state.page >= totalPages || total === 0;
      }
    }

    function truncate(text, limit = 48) {
      if (text.length <= limit) return text;
      return text.slice(0, limit - 3) + "...";
    }

    const MAX_AUTO_RETRIES = 3;
    const AUTO_RETRY_DELAY_MS = 750;

    async function loadCustomers(options = {}) {
      const { allowRetry = false, retryCount = 0 } = options;
      setLoading(true);
      hideError();
      try {
        const params = new URLSearchParams();
        params.set("page", String(state.page));
        params.set("per_page", String(state.perPage));
        if (state.search) {
          params.set("search", state.search);
        }
        if (state.subscribedFilter && state.subscribedFilter !== "all") {
          params.set("subscribed", state.subscribedFilter);
        }

        const response = await authorizedFetch(`/api/customers?${params.toString()}`);
        if (!response.ok) {
          throw new Error("Server returned an error.");
        }
        const data = await response.json();
        state.customers = Array.isArray(data.customers) ? data.customers : [];

        const pagination = data.pagination || {};
        const resolvedTotal = Number(pagination.total);
        state.totalCount = Number.isFinite(resolvedTotal) && resolvedTotal >= 0 ? resolvedTotal : state.customers.length;

        const resolvedPage = Number(pagination.page);
        if (Number.isFinite(resolvedPage) && resolvedPage > 0) {
          state.page = resolvedPage;
        } else if (!state.totalCount) {
          state.page = 1;
        }

        const resolvedPerPage = Number(pagination.per_page);
        if (Number.isFinite(resolvedPerPage) && resolvedPerPage > 0) {
          state.perPage = resolvedPerPage;
          if (elements.pageSizeSelect) {
            elements.pageSizeSelect.value = String(state.perPage);
          }
        }

        const resolvedPages = Number(pagination.total_pages);
        if (Number.isFinite(resolvedPages) && resolvedPages > 0) {
          state.totalPages = resolvedPages;
        } else if (state.totalCount > 0) {
          state.totalPages = Math.max(1, Math.ceil(state.totalCount / state.perPage));
        } else {
          state.totalPages = 1;
        }

        elements.shell.hidden = false;
        renderCustomers();
        renderPagination();
        renderStats(data.stats);
      } catch (error) {
        console.error("loadCustomers failed:", error);
        const nextRetry = retryCount + 1;
        if (allowRetry && nextRetry <= MAX_AUTO_RETRIES) {
          if (elements.loading) {
            elements.loading.hidden = false;
            elements.loading.textContent = `Loading customers… (retry ${nextRetry}/${MAX_AUTO_RETRIES})`;
          }
          window.setTimeout(() => loadCustomers({ allowRetry: true, retryCount: nextRetry }), AUTO_RETRY_DELAY_MS);
          return;
        }
        showError("Unable to load customers. Please try again.");
      } finally {
        setLoading(false);
        if (elements.loading) {
          elements.loading.textContent = "Loading customers…";
        }
      }
    }

    function updateSendEmailButton(customer) {
      if (!elements.sendEmailBtn) return;
      if (state.mode !== "edit" || !customer) {
        elements.sendEmailBtn.hidden = true;
        elements.sendEmailBtn.disabled = true;
        elements.sendEmailBtn.title = "";
        return;
      }
      const canSend = Boolean(customer.email && customer.is_subscribed);
      elements.sendEmailBtn.hidden = false;
      elements.sendEmailBtn.disabled = !canSend;
      elements.sendEmailBtn.title = canSend
        ? ""
        : "Add an email address and ensure the customer is subscribed to send an individual message.";
    }

    function openModal(mode, customer) {
      state.mode = mode;
      state.activeId = customer ? customer.id : null;
      state.currentCustomer = customer || null;
      elements.form.reset();
      elements.alert.hidden = true;
      elements.alert.textContent = "";
      setModalView("form");
      resetEmailPanel();

      if (elements.modeLabel) {
        elements.modeLabel.textContent = mode === "create" ? "New customer" : "Editing customer";
      }
      if (elements.modalTitle) {
        elements.modalTitle.textContent = mode === "create" ? "Add customer" : customer.email;
      }
      if (elements.saveBtn) {
        elements.saveBtn.textContent = mode === "create" ? "Create customer" : "Save changes";
      }

      const formFields = {
        email: elements.form.querySelector("[data-field-email]"),
        firstname: elements.form.querySelector("[data-field-firstname]"),
        lastname: elements.form.querySelector("[data-field-lastname]"),
        company: elements.form.querySelector("[data-field-company]"),
        phone: elements.form.querySelector("[data-field-phone]"),
        comments: elements.form.querySelector("[data-field-comments]"),
        subscribed: elements.form.querySelector("[data-field-subscribed]"),
      };

      if (customer) {
        formFields.email.value = customer.email || "";
        formFields.firstname.value = customer.firstname || "";
        formFields.lastname.value = customer.lastname || "";
        formFields.company.value = customer.company || "";
        formFields.phone.value = customer.phone || "";
        formFields.comments.value = customer.comments || "";
        formFields.subscribed.checked = customer.is_subscribed;
      } else {
        formFields.subscribed.checked = true;
      }

      if (elements.deleteBtn) {
        const canDelete = mode === "edit";
        elements.deleteBtn.hidden = !canDelete;
        elements.deleteBtn.disabled = !canDelete;
        delete elements.deleteBtn.dataset.loading;
      }

      updateSendEmailButton(customer);

      elements.modal.hidden = false;
      document.body.classList.add("modal-open");
      formFields.email.focus();
    }

    function closeModal() {
      elements.modal.hidden = true;
      document.body.classList.remove("modal-open");
      elements.alert.hidden = true;
      elements.alert.textContent = "";
      if (elements.deleteBtn) {
        elements.deleteBtn.hidden = true;
        elements.deleteBtn.disabled = false;
        delete elements.deleteBtn.dataset.loading;
      }
      state.activeId = null;
      state.currentCustomer = null;
      setModalView("form");
      resetEmailPanel();
    }

    function resetEmailPanel(message) {
      state.emailCustomerId = null;
      state.emailSubjectTouched = false;
      state.emailPreviewToken += 1;
      setEmailStatus();
      if (elements.emailPlaceholder && elements.emailPlaceholderText) {
        elements.emailPlaceholder.hidden = false;
        elements.emailPlaceholderText.textContent = message || defaultEmailPlaceholderText;
      }
      if (elements.emailPanel) {
        elements.emailPanel.hidden = true;
      }
      if (elements.emailSendBtn) {
        elements.emailSendBtn.disabled = true;
      }
    }

    function setEmailStatus(message = "", type = "info") {
      if (!elements.emailStatus) return;
      elements.emailStatus.textContent = message;
      elements.emailStatus.hidden = !message;
      elements.emailStatus.classList.remove("error", "success");
      if (message) {
        if (type === "error") {
          elements.emailStatus.classList.add("error");
        } else if (type === "success") {
          elements.emailStatus.classList.add("success");
        }
      }
    }

    async function ensureEmailTemplates() {
      if (emailTemplatesPromise) return emailTemplatesPromise;
      emailTemplatesPromise = (async () => {
        const response = await authorizedFetch("/api/individual-emails");
        if (!response.ok) {
          throw new Error("Unable to load templates.");
        }
        const data = await response.json();
        state.emailTemplates = Array.isArray(data.templates) ? data.templates : [];
        updateEmailTemplateOptions();
        return state.emailTemplates;
      })().catch((error) => {
        emailTemplatesPromise = null;
        throw error;
      });
      return emailTemplatesPromise;
    }

    function updateEmailTemplateOptions() {
      if (!elements.emailTemplateSelect) return;
      elements.emailTemplateSelect.innerHTML = "";
      if (!state.emailTemplates.length) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No templates available";
        option.disabled = true;
        option.selected = true;
        elements.emailTemplateSelect.appendChild(option);
        elements.emailTemplateSelect.disabled = true;
        return;
      }
      elements.emailTemplateSelect.disabled = false;
      state.emailTemplates.forEach((template) => {
        const option = document.createElement("option");
        option.value = template.file;
        option.textContent = template.label;
        elements.emailTemplateSelect.appendChild(option);
      });
      const hasActive = state.activeEmailTemplate && state.emailTemplates.some((item) => item.file === state.activeEmailTemplate);
      if (!hasActive) {
        state.activeEmailTemplate = state.emailTemplates[0].file;
      }
      if (elements.emailTemplateSelect && state.activeEmailTemplate) {
        elements.emailTemplateSelect.value = state.activeEmailTemplate;
      }
    }

    function applyTemplateSubject(templateFile, fallbackSubject) {
      if (!elements.emailSubjectInput) return;
      state.emailSubjectTouched = false;
      const meta = state.emailTemplates.find((item) => item.file === templateFile);
      const nextSubject = fallbackSubject || meta?.subject || meta?.label || "";
      elements.emailSubjectInput.value = nextSubject;
    }

    async function prepareEmailPanel(customer) {
      if (!customer) {
        resetEmailPanel();
        return;
      }
      state.emailCustomerId = customer.id;
      setEmailStatus();
      state.emailSubjectTouched = false;
      if (elements.emailRecipient) {
        const fullName = [customer.firstname, customer.lastname].filter(Boolean).join(" " ).trim();
        elements.emailRecipient.textContent = fullName || customer.email || "Customer";
      }
      if (elements.emailRecipientNote) {
        elements.emailRecipientNote.textContent = customer.email || "No email on file.";
      }
      if (!customer.email) {
        resetEmailPanel("Add an email address to send individual messages.");
        return;
      }
      if (!customer.is_subscribed) {
        resetEmailPanel("This customer unsubscribed and cannot receive email.");
        return;
      }

      try {
        await ensureEmailTemplates();
      } catch (error) {
        console.error(error);
        resetEmailPanel("Unable to load templates. Please try again later.");
        return;
      }

      if (!state.emailTemplates.length) {
        resetEmailPanel("Add HTML files to individual_emails/ to enable sending.");
        return;
      }

      updateEmailTemplateOptions();
      if (elements.emailPlaceholder) {
        elements.emailPlaceholder.hidden = true;
      }
      if (elements.emailPanel) {
        elements.emailPanel.hidden = false;
      }
      if (elements.emailSendBtn) {
        elements.emailSendBtn.disabled = false;
      }

      loadEmailPreview(state.activeEmailTemplate);
    }

    async function loadEmailPreview(templateFile) {
      if (!elements.emailPreviewFrame || !elements.emailPreviewPlaceholder || !state.emailCustomerId) {
        return;
      }
      const token = ++state.emailPreviewToken;
      elements.emailPreviewPlaceholder.hidden = false;
      elements.emailPreviewPlaceholder.textContent = "Rendering preview…";
      elements.emailPreviewFrame.hidden = true;
      try {
        const params = new URLSearchParams();
        params.set("template", templateFile);
        const response = await authorizedFetch(`/api/customers/${encodeURIComponent(state.emailCustomerId)}/individual-emails/preview?${params.toString()}`);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(data.error || "Unable to load preview.");
        }
        if (token !== state.emailPreviewToken) return;
        elements.emailPreviewPlaceholder.hidden = true;
        elements.emailPreviewFrame.hidden = false;
        elements.emailPreviewFrame.srcdoc = data.html || "";
        if (!state.emailSubjectTouched) {
          applyTemplateSubject(templateFile, data.subject);
        }
      } catch (error) {
        if (token !== state.emailPreviewToken) return;
        elements.emailPreviewPlaceholder.hidden = false;
        elements.emailPreviewPlaceholder.textContent = error.message;
        elements.emailPreviewFrame.hidden = true;
        console.error(error);
      }
    }

    async function handleSendIndividualEmail() {
      if (!state.emailCustomerId || !state.activeEmailTemplate || !elements.emailSendBtn) return;
      setEmailStatus();
      const payload = { template: state.activeEmailTemplate };
      const subjectValue = elements.emailSubjectInput ? elements.emailSubjectInput.value.trim() : "";
      if (subjectValue) {
        payload.subject = subjectValue;
      }
      elements.emailSendBtn.disabled = true;
      elements.emailSendBtn.dataset.loading = "true";
      try {
        const response = await authorizedFetch(`/api/customers/${encodeURIComponent(state.emailCustomerId)}/individual-emails/send`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(data.error || "Unable to send email.");
        }
        setEmailStatus(`Sent to ${data.email} with subject "${data.subject}".`, "success");
      } catch (error) {
        setEmailStatus(error.message, "error");
        console.error(error);
      } finally {
        elements.emailSendBtn.disabled = false;
        delete elements.emailSendBtn.dataset.loading;
      }
    }

    function goToPage(targetPage) {
      const maxPage = Math.max(1, state.totalPages || 1);
      const nextPage = Math.min(Math.max(1, targetPage), maxPage);
      if (nextPage === state.page) return;
      state.page = nextPage;
      loadCustomers();
    }

    elements.tableBody.addEventListener("click", (event) => {
      const row = event.target.closest("tr");
      if (!row) return;
      const id = Number(row.dataset.id);
      const customer = state.customers.find((item) => item.id === id);
      if (customer) {
        openModal("edit", customer);
      }
    });

    if (elements.addBtn) {
      elements.addBtn.addEventListener("click", () => openModal("create"));
    }
    if (elements.reloadBtn) {
      elements.reloadBtn.addEventListener("click", () => loadCustomers({ allowRetry: true }));
    }
    elements.form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(elements.form);
      const valueFor = (field) => {
        const value = formData.get(field);
        return value ? value.toString().trim() : "";
      };
      const payload = {
        email: valueFor("email"),
        firstname: valueFor("firstname"),
        lastname: valueFor("lastname"),
        company: valueFor("company"),
        phone: valueFor("phone"),
        comments: valueFor("comments"),
        is_subscribed: elements.form.querySelector("[data-field-subscribed]").checked,
      };

      elements.saveBtn.disabled = true;
      elements.saveBtn.dataset.loading = "true";
      elements.alert.hidden = true;
      elements.alert.textContent = "";

      try {
        const url =
          state.mode === "create"
            ? "/api/customers"
            : `/api/customers/${encodeURIComponent(state.activeId)}`;
        const response = await authorizedFetch(url, {
          method: state.mode === "create" ? "POST" : "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.error || "Unable to save customer.";
          throw new Error(message);
        }

        const customer = data.customer;
        if (!customer) throw new Error("Missing customer payload.");

        if (state.mode === "create") {
          state.page = 1;
        }
        closeModal();
        loadCustomers();
      } catch (error) {
        elements.alert.textContent = error.message;
        elements.alert.hidden = false;
        console.error(error);
      } finally {
        elements.saveBtn.disabled = false;
        delete elements.saveBtn.dataset.loading;
      }
    });

    if (elements.deleteBtn) {
      elements.deleteBtn.addEventListener("click", async () => {
        if (!state.activeId) return;
        if (!window.confirm("Delete this customer permanently?")) {
          return;
        }

        elements.alert.hidden = true;
        elements.alert.textContent = "";
        elements.deleteBtn.disabled = true;
        elements.deleteBtn.dataset.loading = "true";

        try {
          const response = await authorizedFetch(`/api/customers/${encodeURIComponent(state.activeId)}`, {
            method: "DELETE",
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(data.error || "Unable to delete customer.");
          }
          closeModal();
          loadCustomers();
        } catch (error) {
          elements.alert.textContent = error.message;
          elements.alert.hidden = false;
          console.error(error);
        } finally {
          elements.deleteBtn.disabled = false;
          delete elements.deleteBtn.dataset.loading;
        }
      });
    }

    if (elements.cancelBtn) {
      elements.cancelBtn.addEventListener("click", closeModal);
    }
    if (elements.closeBtn) {
      elements.closeBtn.addEventListener("click", closeModal);
    }

    if (elements.sendEmailBtn) {
      elements.sendEmailBtn.addEventListener("click", () => {
        if (!state.currentCustomer) return;
        setModalView("email");
        prepareEmailPanel(state.currentCustomer);
      });
    }

    elements.emailBackBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        setModalView("form");
        resetEmailPanel();
      });
    });

    if (elements.emailTemplateSelect) {
      elements.emailTemplateSelect.addEventListener("change", (event) => {
        const value = event.target.value;
        if (!value) return;
        state.activeEmailTemplate = value;
        applyTemplateSubject(value);
        loadEmailPreview(value);
      });
    }

    if (elements.emailSubjectInput) {
      elements.emailSubjectInput.addEventListener("input", () => {
        state.emailSubjectTouched = true;
      });
    }

    if (elements.emailSendBtn) {
      elements.emailSendBtn.addEventListener("click", handleSendIndividualEmail);
    }

    if (elements.modal) {
      elements.modal.addEventListener("click", (event) => {
        if (event.target === elements.modal) {
          closeModal();
        }
      });
    }

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !elements.modal.hidden) {
        if (state.viewMode === "email") {
          setModalView("form");
          resetEmailPanel();
          return;
        }
        closeModal();
      }
    });

    if (elements.searchInput) {
      elements.searchInput.addEventListener("input", (event) => {
        const { value } = event.target;
        window.clearTimeout(searchTimer);
        searchTimer = window.setTimeout(() => {
          const nextValue = value.trim();
          if (nextValue === state.search) return;
          state.search = nextValue;
          state.page = 1;
          loadCustomers();
        }, SEARCH_DELAY);
      });
    }

    if (elements.subscribedFilterSelect) {
      elements.subscribedFilterSelect.addEventListener("change", (event) => {
        const value = (event.target.value || "all").toLowerCase();
        state.subscribedFilter = value === "subscribed" || value === "unsubscribed" ? value : "all";
        state.page = 1;
        loadCustomers();
      });
    }

    if (elements.pageSizeSelect) {
      elements.pageSizeSelect.addEventListener("change", (event) => {
        const nextValue = Number(event.target.value);
        if (!Number.isFinite(nextValue) || nextValue <= 0 || nextValue === state.perPage) {
          return;
        }
        state.perPage = nextValue;
        state.page = 1;
        loadCustomers();
      });
    }

    if (elements.prevBtn) {
      elements.prevBtn.addEventListener("click", () => goToPage(state.page - 1));
    }
    if (elements.nextBtn) {
      elements.nextBtn.addEventListener("click", () => goToPage(state.page + 1));
    }

    // ── CSV Import ──────────────────────────────────────────────
    let importFile = null;

    function parseCSVHeader(text) {
      const firstLine = text.split(/\r?\n/)[0] || "";
      return firstLine.split(",").map((h) => h.trim().replace(/^"|"$/g, "").trim().toLowerCase());
    }

    function validateImportFile(file) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("No file selected."));
        if (!file.name.toLowerCase().endsWith(".csv")) {
          return reject(new Error("Only .csv files are accepted."));
        }
        const reader = new FileReader();
        reader.onload = () => {
          const headers = parseCSVHeader(reader.result);
          if (!headers.includes("email")) {
            return reject(new Error(
              "CSV is missing the required 'email' column. Found: " + headers.join(", ")
            ));
          }
          resolve(headers);
        };
        reader.onerror = () => reject(new Error("Unable to read the file."));
        reader.readAsText(file.slice(0, 4096));
      });
    }

    function openImportModal() {
      importFile = null;
      if (elements.importFileInput) elements.importFileInput.value = "";
      if (elements.importPlaceholder) elements.importPlaceholder.hidden = false;
      if (elements.importSelected) elements.importSelected.hidden = true;
      if (elements.importAlert) {
        elements.importAlert.hidden = true;
        elements.importAlert.textContent = "";
        elements.importAlert.className = "form-alert";
      }
      if (elements.importUpload) {
        elements.importUpload.disabled = true;
        delete elements.importUpload.dataset.loading;
      }
      if (elements.importFormView) elements.importFormView.hidden = false;
      if (elements.importResults) elements.importResults.hidden = true;
      if (elements.importModal) {
        elements.importModal.hidden = false;
        document.body.classList.add("modal-open");
      }
    }

    function closeImportModal() {
      if (elements.importModal) {
        elements.importModal.hidden = true;
        document.body.classList.remove("modal-open");
      }
      importFile = null;
    }

    async function handleImportFileSelect(file) {
      if (elements.importAlert) {
        elements.importAlert.hidden = true;
        elements.importAlert.textContent = "";
        elements.importAlert.className = "form-alert";
      }
      try {
        await validateImportFile(file);
        importFile = file;
        if (elements.importPlaceholder) elements.importPlaceholder.hidden = true;
        if (elements.importSelected) elements.importSelected.hidden = false;
        if (elements.importFilename) elements.importFilename.textContent = file.name;
        if (elements.importUpload) elements.importUpload.disabled = false;
      } catch (err) {
        importFile = null;
        if (elements.importFileInput) elements.importFileInput.value = "";
        if (elements.importPlaceholder) elements.importPlaceholder.hidden = false;
        if (elements.importSelected) elements.importSelected.hidden = true;
        if (elements.importUpload) elements.importUpload.disabled = true;
        if (elements.importAlert) {
          elements.importAlert.textContent = err.message;
          elements.importAlert.hidden = false;
        }
      }
    }

    async function handleImportUpload() {
      if (!importFile || !elements.importUpload) return;
      elements.importUpload.disabled = true;
      elements.importUpload.dataset.loading = "true";
      if (elements.importAlert) {
        elements.importAlert.hidden = true;
        elements.importAlert.textContent = "";
        elements.importAlert.className = "form-alert";
      }

      try {
        const formData = new FormData();
        formData.append("file", importFile);
        const response = await authorizedFetch("/api/customers/import", {
          method: "POST",
          body: formData,
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(data.error || "Import failed.");
        }

        // Show results view.
        if (elements.importFormView) elements.importFormView.hidden = true;
        if (elements.importResults) elements.importResults.hidden = false;

        const created = data.created || 0;
        const skipped = data.skipped || 0;
        const errors = Array.isArray(data.errors) ? data.errors : [];

        if (elements.importSummary) {
          elements.importSummary.innerHTML = "";
          const msg = document.createElement("p");
          msg.innerHTML =
            `<strong>${created}</strong> customer${created !== 1 ? "s" : ""} imported successfully.` +
            (skipped > 0 ? ` <strong>${skipped}</strong> row${skipped !== 1 ? "s" : ""} skipped.` : "");
          elements.importSummary.appendChild(msg);
        }

        if (elements.importErrors && elements.importErrorList) {
          if (errors.length) {
            elements.importErrors.hidden = false;
            elements.importErrorList.innerHTML = "";
            errors.forEach((err) => {
              const li = document.createElement("li");
              li.textContent = `Row ${err.row}: ${err.email ? err.email + " — " : ""}${err.reason}`;
              elements.importErrorList.appendChild(li);
            });
          } else {
            elements.importErrors.hidden = true;
          }
        }

        // Refresh the table to include newly imported customers.
        if (created > 0) {
          state.page = 1;
          loadCustomers();
        }
      } catch (err) {
        if (elements.importAlert) {
          elements.importAlert.textContent = err.message;
          elements.importAlert.hidden = false;
        }
      } finally {
        elements.importUpload.disabled = false;
        delete elements.importUpload.dataset.loading;
      }
    }

    if (elements.importBtn) {
      elements.importBtn.addEventListener("click", openImportModal);
    }
    if (elements.importClose) {
      elements.importClose.addEventListener("click", closeImportModal);
    }
    if (elements.importCancel) {
      elements.importCancel.addEventListener("click", closeImportModal);
    }
    if (elements.importDone) {
      elements.importDone.addEventListener("click", closeImportModal);
    }
    if (elements.importModal) {
      elements.importModal.addEventListener("click", (event) => {
        if (event.target === elements.importModal) closeImportModal();
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && elements.importModal && !elements.importModal.hidden) {
          closeImportModal();
        }
      });
    }
    if (elements.importBrowse) {
      elements.importBrowse.addEventListener("click", () => {
        if (elements.importFileInput) elements.importFileInput.click();
      });
    }
    if (elements.importFileInput) {
      elements.importFileInput.addEventListener("change", (event) => {
        const file = event.target.files?.[0];
        if (file) handleImportFileSelect(file);
      });
    }
    if (elements.importClear) {
      elements.importClear.addEventListener("click", () => {
        importFile = null;
        if (elements.importFileInput) elements.importFileInput.value = "";
        if (elements.importPlaceholder) elements.importPlaceholder.hidden = false;
        if (elements.importSelected) elements.importSelected.hidden = true;
        if (elements.importUpload) elements.importUpload.disabled = true;
        if (elements.importAlert) {
          elements.importAlert.hidden = true;
          elements.importAlert.textContent = "";
          elements.importAlert.className = "form-alert";
        }
      });
    }
    if (elements.importDropZone) {
      elements.importDropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        elements.importDropZone.classList.add("drag-over");
      });
      elements.importDropZone.addEventListener("dragleave", () => {
        elements.importDropZone.classList.remove("drag-over");
      });
      elements.importDropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        elements.importDropZone.classList.remove("drag-over");
        const file = event.dataTransfer?.files?.[0];
        if (file) handleImportFileSelect(file);
      });
    }
    if (elements.importUpload) {
      elements.importUpload.addEventListener("click", handleImportUpload);
    }

    /* ── manage templates modal ──────────────────────────────── */

    function setManageTplStatus(el, type, msg) {
      if (!el) return;
      if (!type || !msg) {
        el.hidden = true;
        el.textContent = "";
        el.className = "manage-status";
        return;
      }
      el.textContent = msg;
      el.className = `manage-status manage-status--${type}`;
      el.hidden = false;
    }

    function openManageTplModal() {
      if (elements.manageTplModal) {
        elements.manageTplModal.hidden = false;
        document.body.classList.add("modal-open");
        loadTemplateList();
      }
    }

    function closeManageTplModal() {
      if (elements.manageTplModal) {
        elements.manageTplModal.hidden = true;
        document.body.classList.remove("modal-open");
      }
    }

    async function loadTemplateList() {
      if (!elements.manageTplFileList) return;
      elements.manageTplFileList.innerHTML = '<p class="manage-file-list__loading">Loading...</p>';
      setManageTplStatus(elements.manageTplDeleteStatus, null, "");
      try {
        const resp = await authorizedFetch("/api/individual-emails");
        if (!resp.ok) throw new Error("Unable to load template list.");
        const data = await resp.json();
        renderTemplateList(data.templates || []);
      } catch (err) {
        elements.manageTplFileList.innerHTML = "";
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = err.message || "Unable to load files.";
        elements.manageTplFileList.appendChild(p);
      }
    }

    function renderTemplateList(templates) {
      if (!elements.manageTplFileList) return;
      elements.manageTplFileList.innerHTML = "";
      if (!templates.length) {
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = "No template files found.";
        elements.manageTplFileList.appendChild(p);
        return;
      }
      templates.forEach((tpl) => {
        const row = document.createElement("div");
        row.className = "manage-file-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "manage-file-item__name";
        nameSpan.textContent = tpl.file;
        row.appendChild(nameSpan);

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "button manage-file-item__delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => handleTemplateDelete(tpl.file, deleteBtn));
        row.appendChild(deleteBtn);

        elements.manageTplFileList.appendChild(row);
      });
    }

    async function handleTemplateDelete(filename, btn) {
      if (btn.dataset.confirming !== "true") {
        btn.dataset.confirming = "true";
        btn.textContent = "Confirm?";
        btn.classList.add("manage-file-item__delete--confirm");
        setTimeout(() => {
          if (btn.dataset.confirming === "true") {
            btn.dataset.confirming = "";
            btn.textContent = "Delete";
            btn.classList.remove("manage-file-item__delete--confirm");
          }
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.textContent = "Deleting...";
      setManageTplStatus(elements.manageTplDeleteStatus, "info", `Deleting ${filename}...`);
      try {
        const resp = await authorizedFetch(`/api/individual-emails/${encodeURIComponent(filename)}`, {
          method: "DELETE",
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok || payload.ok === false) {
          throw new Error(payload.message || "Unable to delete file.");
        }
        setManageTplStatus(elements.manageTplDeleteStatus, "success", payload.message || `Deleted ${filename}.`);
        emailTemplatesPromise = null;
        await loadTemplateList();
      } catch (err) {
        setManageTplStatus(elements.manageTplDeleteStatus, "error", err.message || "Unable to delete file.");
        btn.disabled = false;
        btn.textContent = "Delete";
        btn.dataset.confirming = "";
        btn.classList.remove("manage-file-item__delete--confirm");
      }
    }

    if (elements.manageTplUploadForm) {
      elements.manageTplUploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!elements.manageTplUploadForm.reportValidity()) return;

        const submitBtn = elements.manageTplUploadForm.querySelector("button[type='submit']");
        if (submitBtn) submitBtn.disabled = true;
        setManageTplStatus(elements.manageTplUploadStatus, "info", "Uploading...");

        try {
          const formData = new FormData(elements.manageTplUploadForm);
          const resp = await authorizedFetch("/api/individual-emails/upload", {
            method: "POST",
            body: formData,
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || "Upload failed.");
          }
          setManageTplStatus(elements.manageTplUploadStatus, "success", payload.message || "Upload successful.");
          elements.manageTplUploadForm.reset();
          emailTemplatesPromise = null;
          await loadTemplateList();
        } catch (err) {
          setManageTplStatus(elements.manageTplUploadStatus, "error", err.message || "Upload failed.");
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    if (elements.manageTplBtn) {
      elements.manageTplBtn.addEventListener("click", openManageTplModal);
    }
    if (elements.manageTplClose) {
      elements.manageTplClose.addEventListener("click", closeManageTplModal);
    }
    if (elements.manageTplModal) {
      elements.manageTplModal.addEventListener("click", (event) => {
        if (event.target === elements.manageTplModal) closeManageTplModal();
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && elements.manageTplModal && !elements.manageTplModal.hidden) {
          closeManageTplModal();
        }
      });
    }

    /* ── Clean Contacts ──────────────────────────────────── */
    const cleanState = {
      duplicates: {},
      invalidEmails: [],
    };

    function openCleanModal() {
      if (!elements.cleanModal) return;
      cleanState.duplicates = {};
      cleanState.invalidEmails = [];
      showCleanView("scan");
      if (elements.cleanScanAlert) {
        elements.cleanScanAlert.hidden = true;
        elements.cleanScanAlert.textContent = "";
      }
      if (elements.cleanScanBtn) {
        elements.cleanScanBtn.disabled = false;
        elements.cleanScanBtn.textContent = "Scan contacts";
      }
      elements.cleanModal.hidden = false;
    }

    function closeCleanModal() {
      if (elements.cleanModal) elements.cleanModal.hidden = true;
    }

    function showCleanView(view) {
      if (elements.cleanScanView) elements.cleanScanView.hidden = view !== "scan";
      if (elements.cleanResultsView) elements.cleanResultsView.hidden = view !== "results";
      if (elements.cleanDoneView) elements.cleanDoneView.hidden = view !== "done";
    }

    function showCleanAlert(el, message, type) {
      if (!el) return;
      el.hidden = false;
      el.textContent = message;
      el.className = "form-alert" + (type === "error" ? " error" : type === "success" ? " success" : "");
    }

    async function scanContacts() {
      if (elements.cleanScanBtn) {
        elements.cleanScanBtn.disabled = true;
        elements.cleanScanBtn.textContent = "Scanning…";
      }
      if (elements.cleanScanAlert) elements.cleanScanAlert.hidden = true;

      try {
        const resp = await authorizedFetch("/api/customers/scan", { method: "POST" });
        if (!resp.ok) {
          const body = await resp.json().catch(() => ({}));
          throw new Error(body.error || "Scan failed.");
        }
        const data = await resp.json();
        cleanState.duplicates = data.duplicates || {};
        cleanState.invalidEmails = Array.isArray(data.invalid_emails) ? data.invalid_emails : [];
        renderCleanResults();
        showCleanView("results");
      } catch (err) {
        showCleanAlert(elements.cleanScanAlert, err.message || "Unable to scan contacts.", "error");
        if (elements.cleanScanBtn) {
          elements.cleanScanBtn.disabled = false;
          elements.cleanScanBtn.textContent = "Scan contacts";
        }
      }
    }

    function renderCleanResults() {
      const dupKeys = Object.keys(cleanState.duplicates);
      const dupCount = dupKeys.length;
      const invalidCount = cleanState.invalidEmails.length;
      const hasDuplicates = dupCount > 0;
      const hasInvalid = invalidCount > 0;
      const allClear = !hasDuplicates && !hasInvalid;

      if (elements.cleanSummary) {
        const parts = [];
        if (hasDuplicates) parts.push(`${dupCount} duplicate group${dupCount !== 1 ? "s" : ""}`);
        if (hasInvalid) parts.push(`${invalidCount} invalid email${invalidCount !== 1 ? "s" : ""}`);
        elements.cleanSummary.textContent = allClear ? "" : `Found ${parts.join(" and ")}.`;
      }

      if (elements.cleanAllClear) elements.cleanAllClear.hidden = !allClear;
      if (elements.cleanDuplicatesSection) elements.cleanDuplicatesSection.hidden = !hasDuplicates;
      if (elements.cleanInvalidSection) elements.cleanInvalidSection.hidden = !hasInvalid;
      if (elements.cleanExecBtn) {
        elements.cleanExecBtn.disabled = allClear;
        elements.cleanExecBtn.textContent = allClear ? "Clean contacts" : "Clean contacts";
      }
      if (elements.cleanExecAlert) elements.cleanExecAlert.hidden = true;

      if (hasDuplicates) renderDuplicateGroups(dupKeys);
      if (hasInvalid) renderInvalidEmails();
      updateCleanButtonLabel();
    }

    function renderDuplicateGroups(keys) {
      if (!elements.cleanGroups) return;
      elements.cleanGroups.innerHTML = "";

      keys.forEach((emailKey) => {
        const group = cleanState.duplicates[emailKey];
        if (!group || group.length < 2) return;

        const card = document.createElement("div");
        card.className = "clean-group";

        const header = document.createElement("div");
        header.className = "clean-group__header";
        header.textContent = emailKey;
        card.appendChild(header);

        const table = document.createElement("table");
        table.className = "clean-group__table";

        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Keep</th><th>ID</th><th>Email</th><th>First</th><th>Last</th><th>Company</th><th>Status</th></tr>";
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        group.forEach((cust, idx) => {
          const tr = document.createElement("tr");

          const radioTd = document.createElement("td");
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = `clean-dup-${emailKey}`;
          radio.value = String(cust.id);
          if (idx === 0) radio.checked = true;
          radio.addEventListener("change", updateCleanButtonLabel);
          radioTd.appendChild(radio);
          tr.appendChild(radioTd);

          function addTd(text) {
            const td = document.createElement("td");
            td.textContent = text || "\u2014";
            tr.appendChild(td);
          }
          addTd(String(cust.id));
          addTd(cust.email);
          addTd(cust.firstname);
          addTd(cust.lastname);
          addTd(cust.company);

          const statusTd = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = cust.is_subscribed ? "status-pill success" : "status-pill muted";
          pill.textContent = cust.is_subscribed ? "Subscribed" : "Unsubscribed";
          statusTd.appendChild(pill);
          tr.appendChild(statusTd);

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);
        elements.cleanGroups.appendChild(card);
      });
    }

    function renderInvalidEmails() {
      if (!elements.cleanInvalidList) return;
      elements.cleanInvalidList.innerHTML = "";

      cleanState.invalidEmails.forEach((entry) => {
        const row = document.createElement("label");
        row.className = "clean-invalid-row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = true;
        cb.value = String(entry.id);
        cb.dataset.cleanInvalidCb = "";
        cb.addEventListener("change", updateCleanButtonLabel);
        row.appendChild(cb);

        const info = document.createElement("span");
        info.className = "clean-invalid-info";
        const emailSpan = document.createElement("strong");
        emailSpan.textContent = entry.email || "(empty)";
        info.appendChild(emailSpan);

        if (entry.firstname || entry.lastname) {
          const nameSpan = document.createElement("span");
          nameSpan.className = "clean-invalid-name";
          nameSpan.textContent = " \u2014 " + [entry.firstname, entry.lastname].filter(Boolean).join(" ");
          info.appendChild(nameSpan);
        }

        const reasonSpan = document.createElement("span");
        reasonSpan.className = "clean-invalid-reason";
        reasonSpan.textContent = entry.reason || "Invalid email";
        info.appendChild(reasonSpan);

        row.appendChild(info);
        elements.cleanInvalidList.appendChild(row);
      });
    }

    function getCleanSelections() {
      const keepIds = {};
      const dupKeys = Object.keys(cleanState.duplicates);
      dupKeys.forEach((emailKey) => {
        const group = cleanState.duplicates[emailKey];
        if (!group || group.length < 2) return;
        const radio = document.querySelector(`input[name="clean-dup-${CSS.escape(emailKey)}"]:checked`);
        if (radio) keepIds[emailKey] = Number(radio.value);
      });

      const deleteInvalidIds = [];
      document.querySelectorAll("[data-clean-invalid-cb]:checked").forEach((cb) => {
        deleteInvalidIds.push(Number(cb.value));
      });

      let totalToDelete = 0;
      for (const emailKey of dupKeys) {
        const group = cleanState.duplicates[emailKey];
        if (group && group.length >= 2) totalToDelete += group.length - 1;
      }
      totalToDelete += deleteInvalidIds.length;

      return { keepIds, deleteInvalidIds, totalToDelete };
    }

    function updateCleanButtonLabel() {
      if (!elements.cleanExecBtn) return;
      const { totalToDelete } = getCleanSelections();
      if (totalToDelete > 0) {
        elements.cleanExecBtn.disabled = false;
        elements.cleanExecBtn.textContent = `Delete ${totalToDelete} contact${totalToDelete !== 1 ? "s" : ""}`;
      } else {
        elements.cleanExecBtn.disabled = true;
        elements.cleanExecBtn.textContent = "Clean contacts";
      }
    }

    async function executeClean() {
      const { keepIds, deleteInvalidIds, totalToDelete } = getCleanSelections();
      if (totalToDelete === 0) return;

      if (elements.cleanExecBtn) {
        elements.cleanExecBtn.disabled = true;
        elements.cleanExecBtn.textContent = "Cleaning…";
      }
      if (elements.cleanExecAlert) elements.cleanExecAlert.hidden = true;

      try {
        const resp = await authorizedFetch("/api/customers/clean", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keep_ids: keepIds, delete_invalid_ids: deleteInvalidIds }),
        });
        if (!resp.ok) {
          const body = await resp.json().catch(() => ({}));
          throw new Error(body.error || "Clean operation failed.");
        }
        const data = await resp.json();
        const deleted = data.deleted || 0;
        const errors = data.errors || [];

        if (elements.cleanDoneSummary) {
          let html = `<p><strong>${deleted}</strong> contact${deleted !== 1 ? "s" : ""} deleted successfully.</p>`;
          if (errors.length) {
            html += `<p class="clean-done-errors-title">${errors.length} error${errors.length !== 1 ? "s" : ""} occurred:</p><ul class="clean-done-errors">`;
            errors.forEach((e) => { html += `<li>${e}</li>`; });
            html += "</ul>";
          }
          elements.cleanDoneSummary.innerHTML = html;
        }
        showCleanView("done");
      } catch (err) {
        showCleanAlert(elements.cleanExecAlert, err.message || "Unable to clean contacts.", "error");
        if (elements.cleanExecBtn) {
          elements.cleanExecBtn.disabled = false;
          updateCleanButtonLabel();
        }
      }
    }

    if (elements.cleanBtn) {
      elements.cleanBtn.addEventListener("click", openCleanModal);
    }
    if (elements.cleanClose) {
      elements.cleanClose.addEventListener("click", closeCleanModal);
    }
    if (elements.cleanCancel) {
      elements.cleanCancel.addEventListener("click", closeCleanModal);
    }
    if (elements.cleanResultsCancel) {
      elements.cleanResultsCancel.addEventListener("click", closeCleanModal);
    }
    if (elements.cleanScanBtn) {
      elements.cleanScanBtn.addEventListener("click", scanContacts);
    }
    if (elements.cleanExecBtn) {
      elements.cleanExecBtn.addEventListener("click", executeClean);
    }
    if (elements.cleanDoneBtn) {
      elements.cleanDoneBtn.addEventListener("click", () => {
        closeCleanModal();
        loadCustomers({ allowRetry: true });
      });
    }
    if (elements.cleanModal) {
      elements.cleanModal.addEventListener("click", (event) => {
        if (event.target === elements.cleanModal) closeCleanModal();
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && elements.cleanModal && !elements.cleanModal.hidden) {
          closeCleanModal();
        }
      });
    }

    window.addEventListener("db-mode-changed", (event) => {
      state.page = 1;
      if (elements.loading) {
        const modeLabel = event?.detail?.mode === "test" ? "test" : "production";
        elements.loading.hidden = false;
        elements.loading.textContent = `Loading ${modeLabel} customers…`;
      }
      loadCustomers({ allowRetry: true });
    });

    loadCustomers({ allowRetry: true });
  })();
</script>
{% endblock %}
