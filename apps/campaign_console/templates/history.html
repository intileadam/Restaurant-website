{% extends 'base.html' %} {% block content %}
<section class="hero hero-utility">
  <div class="hero-copy">
    <p class="eyebrow">Campaigns</p>
    <h2>Campaigns</h2>
    <p>See past campaigns, monitor in-progress sends, and schedule new campaigns.</p>
    <div style="margin-top:0.75rem">
      <a href="{{ url_for('queue_campaign') }}" class="button accent">
        Schedule new campaign
      </a>
    </div>
  </div>
</section>

<div class="history-controls">
  <div class="history-filter" role="group" aria-label="Filter by mode">
    <a
      href="{{ url_for('index') }}"
      class="button {% if mode_filter == 'all' %}accent{% else %}ghost{% endif %} history-filter__button"
    >All</a>
    <a
      href="{{ url_for('index', mode='production') }}"
      class="button {% if mode_filter == 'production' %}accent{% else %}ghost{% endif %} history-filter__button"
    >Production</a>
    <a
      href="{{ url_for('index', mode='test') }}"
      class="button {% if mode_filter == 'test' %}accent{% else %}ghost{% endif %} history-filter__button"
    >Test</a>
  </div>
</div>

{% if sends %}
<div class="history-list">
  {% for send in sends %}
  {% set display_name = send.CAMPAIGN_NAME or send.CAMPAIGN_FILE %}
  <a href="{{ url_for('campaign_history_detail', send_id=send.SEND_ID) }}" class="card history-card">
    <div class="history-card__header">
      <div class="history-card__title">
        <h3>{{ display_name }}</h3>
        <p class="muted history-card__subject">
          File: {{ send.CAMPAIGN_FILE }}
          {% if send.SUBJECT %} · Subject: {{ send.SUBJECT }}{% endif %}
        </p>
      </div>
      <div class="history-card__badges">
        <span class="badge badge--{{ send.MODE }}">{{ send.MODE|capitalize }}</span>
        <span class="badge badge--{{ send.STATUS }}">{% if send.STATUS == 'running' %}In Progress{% else %}{{ send.STATUS|capitalize }}{% endif %}</span>
      </div>
    </div>
    <div class="history-card__stats">
      {% set total = send.TOTAL_RECIPIENTS|int %}
      {% set sent = send.SENT_COUNT|int %}
      {% set failed = send.FAILED_COUNT|int %}
      {% set pending = (total - sent - failed)|int %}
      <div class="history-card__stat">
        <span class="history-card__stat-value">{{ total }}</span>
        <span class="history-card__stat-label">Recipients</span>
      </div>
      <div class="history-card__stat">
        <span class="history-card__stat-value history-card__stat-value--sent">{{ sent }}</span>
        <span class="history-card__stat-label">Sent</span>
      </div>
      <div class="history-card__stat">
        <span class="history-card__stat-value history-card__stat-value--failed">{{ failed }}</span>
        <span class="history-card__stat-label">Failed</span>
      </div>
      <div class="history-card__stat">
        <span class="history-card__stat-value">{{ pending if pending > 0 else 0 }}</span>
        <span class="history-card__stat-label">Pending</span>
      </div>
      <div class="history-card__stat">
        <span
          class="history-card__stat-value"
        >
          {% if send.STARTED_AT %}
          <time
            class="history-card__time"
            data-datetime="{{ send.STARTED_AT.isoformat() }}Z"
          >
            {{ send.STARTED_AT.strftime('%b %d, %Y at %I:%M %p') }}
          </time>
          {% else %}
          —
          {% endif %}
        </span>
        <span class="history-card__stat-label">Date</span>
      </div>
    </div>
  </a>
  {% endfor %}
</div>
{% else %}
<div class="card history-empty">
  <p class="muted">No campaign sends have been recorded yet.</p>
</div>
{% endif %}
<script>
  (function () {
    const nodes = document.querySelectorAll("[data-datetime]");
    nodes.forEach((el) => {
      const raw = el.getAttribute("data-datetime");
      if (!raw) return;
      let d = new Date(raw);
      if (Number.isNaN(d.getTime())) {
        // Try treating the value as UTC.
        d = new Date(raw + "Z");
        if (Number.isNaN(d.getTime())) return;
      }
      try {
        el.textContent = d.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
        });
      } catch {
        // ignore formatting errors
      }
    });
  })();
</script>
{% endblock %}
