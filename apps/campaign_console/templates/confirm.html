{% extends 'base.html' %} {% block content %}
{% set resolved_recipient_count = recipient_count if recipient_count is not none else (recipients|length if recipients else 0) %}
<div class="confirm-page" data-confirm-page>
  <section class="hero hero-utility confirm-hero">
    <div class="hero-copy">
      <p class="eyebrow">Live send</p>
      <h2>Confirm campaign</h2>
      <p>Review the content, pacing, and recipients before launching the send.</p>
    </div>
    <div class="confirm-meta">
      <div class="confirm-meta__item">
        <p class="eyebrow">Campaign</p>
        <p class="confirm-meta__value">{{ file }}</p>
      </div>
      <div class="confirm-meta__item">
        <p class="eyebrow">Subject</p>
        <p class="confirm-meta__value">{{ subject }}</p>
      </div>
      <div class="confirm-meta__item">
        <p class="eyebrow">Recipients</p>
        <p class="confirm-meta__value">{{ resolved_recipient_count }}</p>
      </div>
    </div>
  </section>

  <div class="confirm-grid">
    <section class="card preview-panel confirm-preview">
      <header class="card-header">
        <div>
          <p class="eyebrow">Campaign preview</p>
          <h3>{{ file }}</h3>
        </div>
      </header>
      {% if preview_html %}
      <iframe id="confirmPreviewFrame" class="preview-frame" title="Email preview"></iframe>
      {% else %}
      <div class="preview-error card muted">
        {{ preview_error or "Preview unavailable. Return to the dashboard to reload the preview." }}
      </div>
      {% endif %}
    </section>

    <section class="lint-summary card soft confirm-lint-summary">
      <h3>Lint report</h3>
      {% if lint_has_errors %}
      <p class="lint-summary__status lint-summary__status--error">
        Sending is blocked until the following lint errors are fixed.
      </p>
      {% elif lint_has_warnings %}
      <p class="lint-summary__status lint-summary__status--warning">
        Warnings were found. Review them below, but you may proceed with the send.
      </p>
      {% else %}
      <p class="lint-summary__status lint-summary__status--ok">No lint issues detected.</p>
      {% endif %}
      {% if lint_report.errors %}
      <h4>Errors</h4>
      <ul>
        {% for err in lint_report.errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if lint_report.warnings %}
      <h4>Warnings</h4>
      <ul>
        {% for warning in lint_report.warnings %}
        <li>{{ warning }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if lint_report.notes %}
      <h4>Notes</h4>
      <ul>
        {% for note in lint_report.notes %}
        <li>{{ note }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </section>

    {% if recipients %}
    {% set preview_limit = 5 %}
    <section class="card confirm-recipients">
      <header class="card-header">
        <div>
          <p class="eyebrow">Recipients</p>
          <h3>Recipient preview</h3>
        </div>
      </header>
      <div class="recipient-list">
        <div class="recipient-list__header">
          <p class="muted">Showing up to {{ preview_limit }} rows by default</p>
          {% if recipients|length > preview_limit %}
          <button
            id="recipient-toggle"
            type="button"
            class="button ghost recipient-list__toggle"
            aria-expanded="false"
          >
            Show all recipients ({{ recipients|length - preview_limit }} more)
          </button>
          {% endif %}
        </div>
        <div class="recipient-table-scroll">
          <table id="recipient-table" data-preview-limit="{{ preview_limit }}">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">First name</th>
                <th scope="col">Last name</th>
                <th scope="col">Email</th>
              </tr>
            </thead>
            <tbody>
              {% for customer in recipients %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ customer["FIRSTNAME"] }}</td>
                <td>{{ customer["LASTNAME"] }}</td>
                <td>{{ customer["EMAIL"] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
    {% else %}
    <section class="card confirm-recipients">
      <p>No subscribed customers are available to receive this campaign.</p>
    </section>
    {% endif %}

    <section class="card confirm-send">
      <header class="card-header">
        <div>
          <h3>Send to customers</h3>
        </div>
      </header>
      <form method="post" action="/send">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="file" value="{{ file }}" />
        <input type="hidden" name="subject" value="{{ subject }}" />

        <div class="confirm-form-grid">
          <label>
            <span>Batch size</span>
            <input type="number" name="batch_size" min="1" value="{{ batch_size }}" />
          </label>
          <label>
            <span>Delay (ms)</span>
            <input type="number" name="delay_ms" min="0" value="{{ delay_ms }}" />
          </label>
        </div>

        {% if lint_has_errors %}
        <p class="lint-blocker">Fix the lint errors above to enable the send button.</p>
        {% elif lint_has_warnings %}
        <p class="lint-warning">Warnings were detected, but sending is still allowed.</p>
        {% endif %}

        <button
          type="submit"
          class="button accent full-width"
          {% if lint_has_errors or sending %}disabled aria-disabled="true"{% endif %}
        >
          {% if sending %}Sending...{% else %}Yes, send to customers{% endif %}
        </button>
      </form>
    </section>

    {% if sending %}
    <section id="sendLogSection" class="card send-log confirm-send-log">
      <h3>Send log</h3>
      <p class="eyebrow">Campaign: {{ file }}{% if subject %} · Subject: {{ subject }}{% endif %}</p>
      <pre id="confirmSendLog" tabindex="-1" class="send-log__output"></pre>
      <p id="sendLogFooter" class="muted">Keep this page open to monitor progress. You can safely reload — the send will continue in the background.</p>
    </section>
    {% endif %}
  </div>
  <div class="confirm-footer card soft">
    <a href="{{ url_for('index') }}" class="button ghost full-width">Return to homepage</a>
  </div>
</div>
{% if recipients and recipients|length > preview_limit %}
<script>
  (function () {
    const table = document.getElementById("recipient-table");
    const toggle = document.getElementById("recipient-toggle");
    if (!table || !toggle) return;

    const previewLimit = parseInt(table.dataset.previewLimit || "0", 10);
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    function render(expanded) {
      rows.forEach((row, idx) => {
        const shouldShow = expanded || idx < previewLimit;
        row.style.display = shouldShow ? "" : "none";
      });
      toggle.dataset.expanded = expanded ? "true" : "false";
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      if (expanded) {
        toggle.textContent = "Collapse recipient list";
      } else {
        const remaining = Math.max(rows.length - previewLimit, 0);
        toggle.textContent =
          remaining > 0
            ? `Show all recipients (${remaining} more)`
            : "Show recipients";
      }
    }

    toggle.addEventListener("click", () => {
      const expanded = toggle.dataset.expanded === "true";
      render(!expanded);
    });

    render(false);
  })();
</script>
{% endif %}
{% if preview_html %}
<script>
  (function () {
    const frame = document.getElementById("confirmPreviewFrame");
    if (!frame) return;
    const html = {{ preview_html|tojson|safe }};
    frame.srcdoc = html || "";
  })();
</script>
{% endif %}
{% if sending %}
<script>
  (function () {
    const log = document.getElementById("confirmSendLog");
    const footer = document.getElementById("sendLogFooter");
    if (!log) return;

    const sendId = {{ (send_id or "")|tojson }};
    const initialStatus = {{ (send_status or "running")|tojson }};

    const focusLog = () => {
      const section = document.getElementById("sendLogSection") || log;
      if (section.scrollIntoView) {
        try {
          section.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch (err) {
          section.scrollIntoView();
        }
      }
      if (log.focus) {
        try {
          log.focus({ preventScroll: true });
        } catch (err) {
          log.focus();
        }
      }
    };
    if (window.requestAnimationFrame) {
      window.requestAnimationFrame(focusLog);
    } else {
      setTimeout(focusLog, 0);
    }

    const appendLog = (text) => {
      if (!text) return;
      const needsNewline = log.textContent && !log.textContent.endsWith("\n");
      log.textContent += (needsNewline ? "\n" : "") + text + "\n";
      log.scrollTop = log.scrollHeight;
    };

    const markComplete = () => {
      if (footer) {
        footer.textContent = "Send complete. You may navigate away from this page.";
      }
    };

    const logStreamToken = {{ log_stream_token|tojson }};

    if (initialStatus !== "running") {
      if (sendId) {
        fetch("/send/" + encodeURIComponent(sendId) + "/logs")
          .then((r) => r.json())
          .then((data) => {
            if (data.logs) {
              data.logs.forEach((line) => appendLog(line));
            }
            markComplete();
          })
          .catch(() => {
            appendLog("Unable to load historical log data.");
          });
      } else {
        appendLog("Send already finished.");
        markComplete();
      }
      return;
    }

    if (!logStreamToken) {
      appendLog("⚠ Live log stream unavailable. Reload this page to retry the connection.");
      return;
    }

    const baseStreamUrl = {{ url_for("logs_stream")|tojson }};
    const streamUrl =
      baseStreamUrl +
      (baseStreamUrl.includes("?") ? "&" : "?") +
      "token=" +
      encodeURIComponent(logStreamToken);

    let currentEs = null;
    let done = false;
    let retryDelay = 2000;
    const MAX_RETRY_DELAY = 30000;

    const connect = () => {
      if (done) return;
      log.textContent = "";
      const es = new EventSource(streamUrl);
      currentEs = es;

      es.onmessage = (event) => {
        if (event.data === "__DONE__") {
          done = true;
          try { es.close(); } catch (e) {}
          markComplete();
          return;
        }
        appendLog(event.data);
        retryDelay = 2000;
      };

      es.onerror = () => {
        try { es.close(); } catch (e) {}
        if (done) return;
        appendLog("⚠ Connection lost. Reconnecting in " + Math.round(retryDelay / 1000) + "s...");
        setTimeout(() => {
          connect();
        }, retryDelay);
        retryDelay = Math.min(retryDelay * 2, MAX_RETRY_DELAY);
      };
    };

    connect();

    window.addEventListener("beforeunload", () => {
      done = true;
      try {
        if (currentEs) currentEs.close();
      } catch (err) {}
    });
  })();
</script>
{% endif %}
<script>
  (function () {
    const root = document.querySelector("[data-confirm-page]");
    if (!root) return;
    let reloadRequested = false;
    window.addEventListener("db-mode-changed", (event) => {
      if (reloadRequested) return;
      reloadRequested = true;
      const modeLabel = event?.detail?.mode === "test" ? "test" : "production";
      try {
        const notice = document.createElement("p");
        notice.className = "lint-warning";
        notice.textContent = `Reloading confirmation for ${modeLabel} mode…`;
        root.prepend(notice);
      } catch (err) {
        /* ignore */
      }
      window.setTimeout(() => window.location.reload(), 200);
    });
  })();
</script>
{% endblock %}
