{% extends 'base.html' %} {% block content %}
{% set resolved_recipient_count = recipient_count if recipient_count is not none else (recipients|length if recipients else 0) %}
<div class="confirm-page" data-confirm-page>
  <section class="hero hero-utility confirm-hero">
    <div class="hero-copy">
      <p class="eyebrow">Queue campaign</p>
      <h2>
        {% if campaign_name %}
          {{ campaign_name }}
        {% else %}
          Confirm campaign
        {% endif %}
      </h2>
      <p>Review the content, pacing, and recipients before queuing.</p>
    </div>
    <div class="confirm-meta">
      <div class="confirm-meta__item">
        <p class="eyebrow">Campaign file</p>
        <p class="confirm-meta__value">{{ file }}</p>
      </div>
      <div class="confirm-meta__item">
        <p class="eyebrow">Subject</p>
        <p class="confirm-meta__value">{{ subject }}</p>
      </div>
      <div class="confirm-meta__item">
        <p class="eyebrow">Recipients</p>
        <p class="confirm-meta__value" id="metaRecipientCount">{{ resolved_recipient_count }}</p>
      </div>
    </div>
  </section>

  <div class="confirm-grid">

    <section class="card preview-panel confirm-preview">
      <header class="card-header">
        <div>
          <p class="eyebrow">Campaign preview</p>
          <h3>{{ file }}</h3>
        </div>
      </header>
      {% if preview_html %}
      <iframe id="confirmPreviewFrame" class="preview-frame" title="Email preview"></iframe>
      {% else %}
      <div class="preview-error card muted">
        {{ preview_error or "Preview unavailable. Return to the dashboard to reload the preview." }}
      </div>
      {% endif %}
    </section>

    <section class="lint-summary card soft confirm-lint-summary">
      <h3>Lint report</h3>
      {% if lint_has_errors %}
      <p class="lint-summary__status lint-summary__status--error">
        Queuing is blocked until the following lint errors are fixed.
      </p>
      {% elif lint_has_warnings %}
      <p class="lint-summary__status lint-summary__status--warning">
        Warnings were found. Review them below, but you may proceed.
      </p>
      {% else %}
      <p class="lint-summary__status lint-summary__status--ok">No lint issues detected.</p>
      {% endif %}
      {% if lint_report.errors %}
      <h4>Errors</h4>
      <ul>
        {% for err in lint_report.errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if lint_report.warnings %}
      <h4>Warnings</h4>
      <ul>
        {% for warning in lint_report.warnings %}
        <li>{{ warning }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if lint_report.notes %}
      <h4>Notes</h4>
      <ul>
        {% for note in lint_report.notes %}
        <li>{{ note }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </section>

    {% if recipients %}
    {% set preview_limit = 5 %}
    <section class="card confirm-recipients">
      <header class="card-header">
        <div>
          <p class="eyebrow">Recipients</p>
          <h3>Recipient preview</h3>
        </div>
      </header>
      <div class="recipient-list">
        <div class="recipient-list__header">
          <p class="muted">Showing up to {{ preview_limit }} rows by default</p>
          {% if recipients|length > preview_limit %}
          <button
            id="recipient-toggle"
            type="button"
            class="button ghost recipient-list__toggle"
            aria-expanded="false"
          >
            Show all recipients ({{ recipients|length - preview_limit }} more)
          </button>
          {% endif %}
        </div>
        <div class="recipient-table-scroll">
          <table id="recipient-table" data-preview-limit="{{ preview_limit }}">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">First name</th>
                <th scope="col">Last name</th>
                <th scope="col">Email</th>
              </tr>
            </thead>
            <tbody>
              {% for customer in recipients %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ customer["FIRSTNAME"] }}</td>
                <td>{{ customer["LASTNAME"] }}</td>
                <td>{{ customer["EMAIL"] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
    {% else %}
    <section class="card confirm-recipients">
      <p>No subscribed customers are available to receive this campaign.</p>
    </section>
    {% endif %}

    <section class="card confirm-send">
      <header class="card-header">
        <div>
          <h3>Queue campaign</h3>
        </div>
      </header>
      <form method="post" action="/queue">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="file" value="{{ file }}" />
        <input type="hidden" name="subject" value="{{ subject }}" />
        <input type="hidden" name="campaign_name" value="{{ campaign_name or '' }}" />

        <div class="confirm-form-grid">
          <label>
            <span>Batch size</span>
            <input type="number" name="batch_size" min="1" value="{{ batch_size }}" />
          </label>
          <label>
            <span>Delay per email (seconds)</span>
            <input type="number" name="delay_seconds" min="0" value="{{ delay_seconds }}" />
          </label>
          <label>
            <span>Cooldown between batches (minutes)</span>
            <input type="number" name="cooldown_minutes" min="0" value="{{ cooldown_minutes }}" />
          </label>
        </div>

        {% if estimated_send_time %}
        <p class="confirm-estimate muted">
          Estimated total send time:
          <strong id="estimatedSendTime">{{ estimated_send_time }}</strong>
          for
          <span id="estimatedRecipientCount">{{ recipient_count }}</span>
          recipient{{ "s" if recipient_count != 1 else "" }}.
          The send runs in the background — you can sign out and return later.
        </p>
        {% endif %}

        {% if lint_has_errors %}
        <p class="lint-blocker">Fix the lint errors above to enable the queue button.</p>
        {% elif lint_has_warnings %}
        <p class="lint-warning">Warnings were detected, but queuing is still allowed.</p>
        {% endif %}

        <button
          type="submit"
          class="button accent full-width"
          {% if lint_has_errors %}disabled aria-disabled="true"{% endif %}
        >
          Queue campaign
        </button>
      </form>
    </section>
  </div>
  <div class="confirm-footer card soft">
    <a href="{{ url_for('index') }}" class="button ghost full-width">Return to homepage</a>
  </div>
</div>

{% if recipients and recipients|length > preview_limit %}
<script>
  (function () {
    const table = document.getElementById("recipient-table");
    const toggle = document.getElementById("recipient-toggle");
    if (!table || !toggle) return;

    const previewLimit = parseInt(table.dataset.previewLimit || "0", 10);
    const rows = Array.from(table.querySelectorAll("tbody tr"));

    function render(expanded) {
      rows.forEach((row, idx) => {
        const shouldShow = expanded || idx < previewLimit;
        row.style.display = shouldShow ? "" : "none";
      });
      toggle.dataset.expanded = expanded ? "true" : "false";
      toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
      if (expanded) {
        toggle.textContent = "Collapse recipient list";
      } else {
        const remaining = Math.max(rows.length - previewLimit, 0);
        toggle.textContent =
          remaining > 0
            ? `Show all recipients (${remaining} more)`
            : "Show recipients";
      }
    }

    toggle.addEventListener("click", () => {
      const expanded = toggle.dataset.expanded === "true";
      render(!expanded);
    });

    render(false);
  })();
</script>
{% endif %}
{% if preview_html %}
<script>
  (function () {
    const frame = document.getElementById("confirmPreviewFrame");
    if (!frame) return;
    const html = {{ preview_html|tojson|safe }};
    frame.srcdoc = html || "";
  })();
</script>
{% endif %}
<script>
  (function () {
    const root = document.querySelector("[data-confirm-page]");
    if (!root) return;
    let reloadRequested = false;
    window.addEventListener("db-mode-changed", (event) => {
      if (reloadRequested) return;
      reloadRequested = true;
      const modeLabel = event?.detail?.mode === "test" ? "test" : "production";
      try {
        const notice = document.createElement("p");
        notice.className = "lint-warning";
        notice.textContent = `Reloading confirmation for ${modeLabel} mode…`;
        root.prepend(notice);
      } catch (err) {
        /* ignore */
      }
      window.setTimeout(() => window.location.reload(), 200);
    });
  })();
  (function () {
    const estimateEl = document.getElementById("estimatedSendTime");
    const recipientCountEl = document.getElementById("estimatedRecipientCount");
    const batchInput = document.querySelector('input[name="batch_size"]');
    const delayInput = document.querySelector('input[name="delay_seconds"]');
    const cooldownInput = document.querySelector('input[name="cooldown_minutes"]');
    if (!estimateEl || !recipientCountEl || !batchInput || !delayInput || !cooldownInput) return;

    const baseRecipients = parseInt(recipientCountEl.textContent || "0", 10) || 0;

    function formatDuration(seconds) {
      const s = Math.max(0, Math.round(seconds || 0));
      if (s < 60) return "under 1 minute";
      const hours = Math.floor(s / 3600);
      const minutes = Math.round((s % 3600) / 60);
      if (hours && minutes) return `~${hours}h ${minutes}m`;
      if (hours) return `~${hours}h`;
      return `~${minutes}m`;
    }

    function recalcEstimate() {
      if (!baseRecipients) return;
      const batchSize = Math.max(1, parseInt(batchInput.value, 10) || 1);
      const delaySeconds = Math.max(0, parseInt(delayInput.value, 10) || 0);
      const cooldownMinutes = Math.max(0, parseInt(cooldownInput.value, 10) || 0);
      const cooldownSeconds = cooldownMinutes * 60;
      const numBatches = Math.max(1, Math.ceil(baseRecipients / batchSize));
      const totalCooldown = Math.max(0, numBatches - 1) * cooldownSeconds;
      const estimatedSeconds = totalCooldown + baseRecipients * delaySeconds;
      estimateEl.textContent = formatDuration(estimatedSeconds);
    }

    batchInput.addEventListener("input", recalcEstimate);
    batchInput.addEventListener("change", recalcEstimate);
    delayInput.addEventListener("input", recalcEstimate);
    delayInput.addEventListener("change", recalcEstimate);
    cooldownInput.addEventListener("input", recalcEstimate);
    cooldownInput.addEventListener("change", recalcEstimate);
    recalcEstimate();
  })();
</script>
{% endblock %}
