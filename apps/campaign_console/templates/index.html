{% extends 'base.html' %} {% block content %}
<section class="hero hero-utility">
  <div class="hero-copy">
    <p class="eyebrow">Workflow</p>
    <h2>Prepare and queue campaigns</h2>
    <p>
      Follow the steps below in order. Each section unlocks once a campaign file
      is selected.
    </p>
    <p>
      Need a new template? Upload an HTML file below or drop it into
      <code>campaigns/</code> and refresh this page.
    </p>
    <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap">
      <button
        type="button"
        class="button outline hero-upload-button"
        id="openManageModal"
      >
        Manage campaigns
      </button>
      <span id="schedulerIndicator" style="display:inline-flex;align-items:center;gap:0.35rem;font-size:0.85rem;color:var(--color-muted,#888)">
        <span id="schedulerDot" style="width:8px;height:8px;border-radius:50%;background:#888;display:inline-block"></span>
        <span id="schedulerLabel">Scheduler: checking...</span>
      </span>
    </div>
  </div>
</section>

<div id="activeSendBanner" class="card soft" style="margin-bottom:1rem;display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem">
    <div>
      <strong id="activeSendFile"></strong>
      <span class="muted" id="activeSendProgress"></span>
    </div>
    <a id="activeSendLink" href="#" class="button primary" style="font-size:0.85rem">View progress</a>
  </div>
</div>

<div id="campaign-workflow" class="dashboard-grid">
  <section class="card focus-card preview-panel">
    <header class="card-header">
      <div>
        <p class="eyebrow">Step 1</p>
        <h2>Select a campaign</h2>
      </div>
      <span class="badge">Required</span>
    </header>
    <div class="focus-card__form">
      <label for="campaignSelect" class="field-label">Campaign file</label>
      <div class="field-control">
        <select id="campaignSelect">
          <option value="" selected>Select a campaign...</option>
          {% for f in campaign_files %}
          <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>
        <svg aria-hidden="true" viewBox="0 0 20 20">
          <path d="M6 8l4 4 4-4" />
        </svg>
      </div>
      <p class="help-text">
        Selecting a file automatically refreshes the preview and unlocks test
        and live send actions.
      </p>
    </div>
    <div class="focus-card__preview">
      <div class="preview-header">
        <h3>Email preview</h3>
        <button
          type="button"
          class="button ghost"
          id="reloadPreview"
          data-requires-selection
          disabled
        >
          Reload preview
        </button>
      </div>
      <div id="previewPlaceholder" class="preview-placeholder">
        Choose a campaign to render a fully responsive preview.
      </div>
      <iframe
        id="previewFrame"
        class="preview-frame"
        title="Email preview"
        hidden
      ></iframe>
      <div id="previewError" class="preview-error card muted" hidden></div>

      <section id="lintSection" class="lint card soft" hidden>
        <div class="lint-header">
          <h3>Lint report</h3>
          <span class="lint-chip">Auto generated</span>
        </div>
        <div id="lintContent"></div>
      </section>
    </div>
  </section>

  <div class="workflow-actions">
    <section class="card form-card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Step 2</p>
          <h2>Send a test</h2>
        </div>
      </header>
      <form method="post" action="/send-test" class="form-grid" id="testEmailForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="file" id="testFileInput" data-sync="file" />
        <label for="test_subject">Subject</label>
        <input
          type="text"
          id="test_subject"
          name="subject"
          placeholder="e.g., Weekend Specials"
          required
        />

        <label for="test_email">Send test to</label>
        <input
          type="email"
          id="test_email"
          name="email"
          placeholder="name@casadelpollo.com"
          required
        />

        <button
          type="submit"
          class="button primary full-width"
          data-requires-selection
          data-requires-clean-lint
          disabled
        >
          Send test email
        </button>
        <p class="lint-status" data-lint-status="test" hidden></p>
        <p
          id="testEmailStatus"
          class="lint-status form-status"
          aria-live="polite"
          hidden
        ></p>
      </form>
    </section>

    <section class="card form-card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Step 3</p>
          <h2>Queue campaign</h2>
        </div>
      </header>
      <form method="get" action="/confirm" class="form-grid">
        <input type="hidden" name="file" id="sendFileInput" data-sync="file" />

        <label for="subject2">Subject</label>
        <input
          type="text"
          id="subject2"
          name="subject"
          placeholder="Subject line for customers"
          required
        />

        <button
          type="submit"
          class="button accent full-width"
          data-requires-selection
          data-requires-clean-lint
          disabled
        >
          Review &amp; confirm
        </button>
        <p class="lint-status" data-lint-status="live" hidden></p>
      </form>
    </section>
  </div>

</div>

<div class="workflow-modal-backdrop" id="adminModal" hidden>
  <div
    class="workflow-modal card admin-card"
    role="dialog"
    aria-modal="true"
    aria-labelledby="adminModalTitle"
  >
    <button
      type="button"
      class="workflow-modal__close"
      data-close-modal
      aria-label="Close manage admins dialog"
    >
      &times;
    </button>
    <header class="card-header">
      <div>
        <p class="eyebrow">Team access</p>
        <h2 id="adminModalTitle">Manage admins</h2>
      </div>
      <span class="badge">Admins only</span>
    </header>

    <section class="manage-section">
      <h3 class="manage-section__title">Current admins</h3>
      <div id="adminUserList" class="admin-user-list">
        <p class="admin-user-list__loading">Loading...</p>
      </div>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Add new admin</h3>
      <p class="manage-section__lead">
        New accounts can sign in immediately after being added.
      </p>
      <form method="post" action="{{ url_for('add_operator') }}" class="form-grid user-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <label for="operator_email">Email address</label>
        <input
          type="email"
          id="operator_email"
          name="operator_email"
          placeholder="name@casadelpollo.com"
          required
        />

        <label for="operator_password">Password</label>
        <input
          type="password"
          id="operator_password"
          name="operator_password"
          minlength="{{ min_password_length }}"
          placeholder="Minimum {{ min_password_length }} characters"
          required
        />

        <label for="operator_password_confirm">Confirm password</label>
        <input
          type="password"
          id="operator_password_confirm"
          name="operator_password_confirm"
          minlength="{{ min_password_length }}"
          required
        />

        <button type="submit" class="button primary full-width">
          Add admin
        </button>
      </form>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Change your password</h3>
      <p class="manage-section__lead">
        Update the password for <strong>{{ g.user.username if g.user else '' }}</strong>.
      </p>
      <form method="post" action="{{ url_for('change_own_password') }}" class="form-grid user-form" id="changePasswordForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <label for="current_password">Current password</label>
        <input
          type="password"
          id="current_password"
          name="current_password"
          required
        />

        <label for="new_password">New password</label>
        <input
          type="password"
          id="new_password"
          name="new_password"
          minlength="{{ min_password_length }}"
          placeholder="Minimum {{ min_password_length }} characters"
          required
        />

        <label for="new_password_confirm">Confirm new password</label>
        <input
          type="password"
          id="new_password_confirm"
          name="new_password_confirm"
          minlength="{{ min_password_length }}"
          required
        />

        <button type="submit" class="button primary full-width">
          Change password
        </button>
      </form>
    </section>
  </div>
</div>

<div class="workflow-modal-backdrop" id="manageModal" hidden>
  <div
    class="workflow-modal card manage-card"
    role="dialog"
    aria-modal="true"
    aria-labelledby="manageModalTitle"
  >
    <button
      type="button"
      class="workflow-modal__close"
      data-close-modal
      aria-label="Close manage campaigns dialog"
    >
      &times;
    </button>
    <header class="card-header">
      <div>
        <h2 id="manageModalTitle">Manage campaigns</h2>
      </div>
    </header>

    <div id="diskUsageBar" class="disk-usage" hidden>
      <div class="disk-usage__label">
        <span id="diskUsageText">Loading...</span>
      </div>
      <div class="disk-usage__track">
        <div id="diskUsageFill" class="disk-usage__fill" style="width:0%"></div>
      </div>
    </div>

    <section class="manage-section">
      <h3 class="manage-section__title">Campaign files</h3>
      <p class="manage-section__lead">
        Files stored in <code>campaigns/</code>. Delete any file you no longer need.
      </p>
      <div id="manageFileList" class="manage-file-list">
        <p class="manage-file-list__loading">Loading...</p>
      </div>
      <p
        id="manageDeleteStatus"
        class="manage-status"
        aria-live="polite"
        hidden
      ></p>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Upload new file</h3>
      <form
        id="manageUploadForm"
        class="upload-card__form form-grid"
        enctype="multipart/form-data"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <label for="campaign_file">HTML file</label>
        <input
          type="file"
          id="campaign_file"
          name="campaign_file"
          accept=".html,text/html"
          required
        />

        <label for="campaign_filename">Save as (optional)</label>
        <input
          type="text"
          id="campaign_filename"
          name="filename"
          placeholder="my-email.html"
          inputmode="text"
        />

        <button type="submit" class="button secondary full-width">
          Upload HTML
        </button>
        <p
          id="manageUploadStatus"
          class="manage-status"
          aria-live="polite"
          hidden
        ></p>
      </form>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Campaign images</h3>
      <p class="manage-section__lead">
        Upload images for use in email campaigns. Copy the URL and paste it
        into your campaign HTML.
      </p>
      <div id="imageFileList" class="manage-file-list">
        <p class="manage-file-list__loading">Loading...</p>
      </div>
      <p
        id="imageDeleteStatus"
        class="manage-status"
        aria-live="polite"
        hidden
      ></p>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Upload new image</h3>
      <form
        id="imageUploadForm"
        class="upload-card__form form-grid"
        enctype="multipart/form-data"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <label for="image_file">Image file</label>
        <input
          type="file"
          id="image_file"
          name="image_file"
          accept=".jpg,.jpeg,.png,.gif,.webp,image/*"
          required
        />

        <label for="image_filename">Save as (optional)</label>
        <input
          type="text"
          id="image_filename"
          name="filename"
          placeholder="chicken-casado.jpg"
          inputmode="text"
        />

        <button type="submit" class="button secondary full-width">
          Upload Image
        </button>
        <p
          id="imageUploadStatus"
          class="manage-status"
          aria-live="polite"
          hidden
        ></p>
      </form>
    </section>
  </div>
</div>

<div class="workflow-modal-backdrop" id="filePreviewModal" hidden>
  <div
    class="workflow-modal card file-preview-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="filePreviewTitle"
  >
    <button
      type="button"
      class="workflow-modal__close"
      data-close-modal
      aria-label="Close preview"
    >
      &times;
    </button>
    <header class="card-header">
      <div>
        <h2 id="filePreviewTitle">Preview</h2>
      </div>
    </header>
    <div class="file-preview-modal__body">
      <p id="filePreviewLoading" class="file-preview-modal__loading">Loading preview...</p>
      <iframe
        id="filePreviewFrame"
        class="file-preview-modal__frame"
        title="Campaign preview"
        hidden
      ></iframe>
      <p id="filePreviewError" class="file-preview-modal__error" hidden></p>
    </div>
  </div>
</div>

<script>
  (() => {
    const manageModal = document.getElementById("manageModal");
    const manageTrigger = document.getElementById("openManageModal");
    const adminModal = document.getElementById("adminModal");
    const adminTrigger = document.querySelector("[data-open-admin-modal]");
    const adminUserList = document.getElementById("adminUserList");
    const select = document.getElementById("campaignSelect");
    const previewFrame = document.getElementById("previewFrame");
    const previewPlaceholder = document.getElementById("previewPlaceholder");
    const previewError = document.getElementById("previewError");
    const reloadButton = document.getElementById("reloadPreview");
    const lintSection = document.getElementById("lintSection");
    const lintContent = document.getElementById("lintContent");
    const syncInputs = document.querySelectorAll("[data-sync='file']");
    const gatedControls = document.querySelectorAll(
      "[data-requires-selection]"
    );
    const lintDependentControls = document.querySelectorAll(
      "[data-requires-clean-lint]"
    );
    const lintStatusTargets = document.querySelectorAll("[data-lint-status]");
    const testForm = document.getElementById("testEmailForm");
    const testStatus = document.getElementById("testEmailStatus");

    const manageFileList = document.getElementById("manageFileList");
    const manageUploadForm = document.getElementById("manageUploadForm");
    const manageUploadStatus = document.getElementById("manageUploadStatus");
    const manageDeleteStatus = document.getElementById("manageDeleteStatus");
    const filePreviewModal = document.getElementById("filePreviewModal");
    const filePreviewTitle = document.getElementById("filePreviewTitle");
    const filePreviewFrame = document.getElementById("filePreviewFrame");
    const filePreviewLoading = document.getElementById("filePreviewLoading");
    const filePreviewError = document.getElementById("filePreviewError");

    const imageFileList = document.getElementById("imageFileList");
    const imageUploadForm = document.getElementById("imageUploadForm");
    const imageUploadStatus = document.getElementById("imageUploadStatus");
    const imageDeleteStatus = document.getElementById("imageDeleteStatus");
    const diskUsageBar = document.getElementById("diskUsageBar");
    const diskUsageText = document.getElementById("diskUsageText");
    const diskUsageFill = document.getElementById("diskUsageFill");

    let controller = null;
    let lintReport = null;
    let lintStatusMessage = "";

    /* ── helpers ─────────────────────────────────────────────── */

    function csrfHeaders(extra = {}) {
      const headers = { "X-Requested-With": "XMLHttpRequest", Accept: "application/json", ...extra };
      const token = window.getCsrfToken ? window.getCsrfToken() : "";
      if (token) headers["X-CSRF-Token"] = token;
      return headers;
    }

    function setManageStatus(el, state, message) {
      if (!el) return;
      if (!message) {
        el.hidden = true;
        el.textContent = "";
        el.className = "manage-status";
        return;
      }
      el.hidden = false;
      el.textContent = message;
      el.className = "manage-status";
      if (state === "error") el.classList.add("manage-status--error");
      else if (state === "success") el.classList.add("manage-status--success");
      else el.classList.add("manage-status--info");
    }

    /* ── file preview modal ─────────────────────────────────── */

    function openFilePreview(filename) {
      filePreviewTitle.textContent = filename;
      filePreviewFrame.hidden = true;
      filePreviewFrame.srcdoc = "";
      filePreviewLoading.hidden = false;
      filePreviewError.hidden = true;
      filePreviewModal.removeAttribute("hidden");
      syncModalBodyState();

      fetch(`/preview?file=${encodeURIComponent(filename)}`, {
        headers: { Accept: "application/json" },
      })
        .then((r) => (r.ok ? r.json() : r.json().then((p) => Promise.reject(p))))
        .then((data) => {
          filePreviewLoading.hidden = true;
          filePreviewFrame.srcdoc = data.html || "";
          filePreviewFrame.hidden = false;
        })
        .catch((err) => {
          filePreviewLoading.hidden = true;
          filePreviewError.textContent = (err && err.error) || "Preview unavailable.";
          filePreviewError.hidden = false;
        });
    }

    function closeFilePreview() {
      filePreviewModal.setAttribute("hidden", "");
      filePreviewFrame.srcdoc = "";
      syncModalBodyState();
    }

    /* ── campaign select sync ────────────────────────────────── */

    function syncSelectOptions(files) {
      const previousValue = select.value;
      const placeholder = select.querySelector("option[value='']");
      select.innerHTML = "";
      if (placeholder) {
        select.appendChild(placeholder);
      } else {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select a campaign...";
        select.appendChild(opt);
      }
      files.forEach((f) => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        select.appendChild(opt);
      });
      if (files.includes(previousValue)) {
        select.value = previousValue;
      } else {
        select.value = "";
        select.dispatchEvent(new Event("change"));
      }
    }

    /* ── admin modal: user list ──────────────────────────────── */

    async function loadAdminList() {
      if (!adminUserList) return;
      adminUserList.innerHTML = '<p class="admin-user-list__loading">Loading...</p>';
      try {
        const resp = await fetch("/users", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error("Unable to load admin list.");
        const data = await resp.json();
        renderAdminList(data.users || []);
      } catch (err) {
        adminUserList.innerHTML = "";
        const p = document.createElement("p");
        p.className = "admin-user-list__empty";
        p.textContent = err.message || "Unable to load admins.";
        adminUserList.appendChild(p);
      }
    }

    function renderAdminList(users) {
      adminUserList.innerHTML = "";
      if (!users.length) {
        const p = document.createElement("p");
        p.className = "admin-user-list__empty";
        p.textContent = "No admin accounts found.";
        adminUserList.appendChild(p);
        return;
      }
      const table = document.createElement("table");
      table.className = "admin-table";
      const thead = document.createElement("thead");
      thead.innerHTML =
        "<tr><th>Email</th><th>Role</th><th>Status</th><th>Last login</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      users.forEach((u) => {
        const tr = document.createElement("tr");
        const emailTd = document.createElement("td");
        emailTd.textContent = u.username;
        const roleTd = document.createElement("td");
        roleTd.textContent = u.role || "admin";
        const statusTd = document.createElement("td");
        statusTd.textContent = u.is_active ? "Active" : "Inactive";
        statusTd.className = u.is_active ? "status-active" : "status-inactive";
        const loginTd = document.createElement("td");
        if (u.last_login_at) {
          const d = new Date(u.last_login_at);
          loginTd.textContent = d.toLocaleDateString(undefined, {
            year: "numeric", month: "short", day: "numeric",
            hour: "2-digit", minute: "2-digit",
          });
        } else {
          loginTd.textContent = "Never";
          loginTd.className = "text-muted";
        }
        tr.appendChild(emailTd);
        tr.appendChild(roleTd);
        tr.appendChild(statusTd);
        tr.appendChild(loginTd);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      adminUserList.appendChild(table);
    }

    /* ── manage modal: file list ─────────────────────────────── */

    async function loadCampaignList() {
      manageFileList.innerHTML = '<p class="manage-file-list__loading">Loading...</p>';
      setManageStatus(manageDeleteStatus, null, "");
      try {
        const resp = await fetch("/api/campaigns", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error("Unable to load campaign list.");
        const files = await resp.json();
        renderFileList(files);
        syncSelectOptions(files);
      } catch (err) {
        manageFileList.innerHTML = "";
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = err.message || "Unable to load files.";
        manageFileList.appendChild(p);
      }
    }

    function renderFileList(files) {
      manageFileList.innerHTML = "";
      if (!files.length) {
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = "No campaign files found.";
        manageFileList.appendChild(p);
        return;
      }
      files.forEach((filename) => {
        const row = document.createElement("div");
        row.className = "manage-file-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "manage-file-item__name";
        nameSpan.textContent = filename;
        nameSpan.addEventListener("click", () => openFilePreview(filename));
        row.appendChild(nameSpan);

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "button manage-file-item__delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => handleDelete(filename, deleteBtn));
        row.appendChild(deleteBtn);

        manageFileList.appendChild(row);
      });
    }

    async function handleDelete(filename, btn) {
      if (btn.dataset.confirming !== "true") {
        btn.dataset.confirming = "true";
        btn.textContent = "Confirm?";
        btn.classList.add("manage-file-item__delete--confirm");
        setTimeout(() => {
          if (btn.dataset.confirming === "true") {
            btn.dataset.confirming = "";
            btn.textContent = "Delete";
            btn.classList.remove("manage-file-item__delete--confirm");
          }
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.textContent = "Deleting...";
      setManageStatus(manageDeleteStatus, "info", `Deleting ${filename}...`);
      try {
        const resp = await fetch(`/api/campaigns/${encodeURIComponent(filename)}`, {
          method: "DELETE",
          headers: csrfHeaders(),
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok || payload.ok === false) {
          throw new Error(payload.message || "Unable to delete file.");
        }
        setManageStatus(manageDeleteStatus, "success", payload.message || `Deleted ${filename}.`);
        await loadCampaignList();
        await loadDiskUsage();
      } catch (err) {
        setManageStatus(manageDeleteStatus, "error", err.message || "Unable to delete file.");
        btn.disabled = false;
        btn.textContent = "Delete";
        btn.dataset.confirming = "";
        btn.classList.remove("manage-file-item__delete--confirm");
      }
    }

    /* ── manage modal: upload ────────────────────────────────── */

    if (manageUploadForm) {
      manageUploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!manageUploadForm.reportValidity()) return;

        const submitBtn = manageUploadForm.querySelector("button[type='submit']");
        if (submitBtn) submitBtn.disabled = true;
        setManageStatus(manageUploadStatus, "info", "Uploading...");

        try {
          const formData = new FormData(manageUploadForm);
          const resp = await fetch("{{ url_for('upload_campaign') }}", {
            method: "POST",
            body: formData,
            headers: csrfHeaders({ Accept: "application/json" }),
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || "Upload failed.");
          }
          setManageStatus(manageUploadStatus, "success", payload.message || "Upload successful.");
          manageUploadForm.reset();
          await loadCampaignList();
          await loadDiskUsage();
        } catch (err) {
          setManageStatus(manageUploadStatus, "error", err.message || "Upload failed.");
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    /* ── disk usage ────────────────────────────────────────────── */

    async function loadDiskUsage() {
      try {
        const resp = await fetch("/api/disk-usage", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error("Unable to load disk usage.");
        const data = await resp.json();
        diskUsageText.textContent = `${data.used_human} / ${data.total_human} used`;
        diskUsageFill.style.width = `${Math.min(data.percent, 100)}%`;
        diskUsageFill.classList.remove("disk-usage__fill--warn", "disk-usage__fill--danger");
        if (data.percent >= 90) {
          diskUsageFill.classList.add("disk-usage__fill--danger");
        } else if (data.percent >= 75) {
          diskUsageFill.classList.add("disk-usage__fill--warn");
        }
        diskUsageBar.hidden = false;
      } catch {
        diskUsageBar.hidden = true;
      }
    }

    /* ── campaign images: file list ───────────────────────────── */

    async function loadImageList() {
      imageFileList.innerHTML = '<p class="manage-file-list__loading">Loading...</p>';
      setManageStatus(imageDeleteStatus, null, "");
      try {
        const resp = await fetch("/api/campaign-images", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error("Unable to load image list.");
        const images = await resp.json();
        renderImageList(images);
      } catch (err) {
        imageFileList.innerHTML = "";
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = err.message || "Unable to load images.";
        imageFileList.appendChild(p);
      }
    }

    function renderImageList(images) {
      imageFileList.innerHTML = "";
      if (!images.length) {
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = "No images uploaded yet.";
        imageFileList.appendChild(p);
        return;
      }
      images.forEach((img) => {
        const row = document.createElement("div");
        row.className = "manage-image-item";

        const thumb = document.createElement("img");
        thumb.src = img.url;
        thumb.alt = img.filename;
        thumb.className = "manage-image-item__thumb";
        row.appendChild(thumb);

        const nameSpan = document.createElement("span");
        nameSpan.className = "manage-image-item__name";
        nameSpan.textContent = img.filename;
        row.appendChild(nameSpan);

        const actions = document.createElement("span");
        actions.className = "manage-image-item__actions";

        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "button manage-image-item__copy";
        copyBtn.textContent = "Copy URL";
        copyBtn.addEventListener("click", () => handleCopyUrl(img.url, copyBtn));
        actions.appendChild(copyBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "button manage-file-item__delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => handleImageDelete(img.filename, deleteBtn));
        actions.appendChild(deleteBtn);

        row.appendChild(actions);
        imageFileList.appendChild(row);
      });
    }

    async function handleCopyUrl(url, btn) {
      try {
        await navigator.clipboard.writeText(url);
        const original = btn.textContent;
        btn.textContent = "Copied!";
        btn.classList.add("manage-image-item__copy--success");
        setTimeout(() => {
          btn.textContent = original;
          btn.classList.remove("manage-image-item__copy--success");
        }, 2000);
      } catch {
        setManageStatus(imageDeleteStatus, "error", "Unable to copy URL. Please copy it manually.");
      }
    }

    async function handleImageDelete(filename, btn) {
      if (btn.dataset.confirming !== "true") {
        btn.dataset.confirming = "true";
        btn.textContent = "Confirm?";
        btn.classList.add("manage-file-item__delete--confirm");
        setTimeout(() => {
          if (btn.dataset.confirming === "true") {
            btn.dataset.confirming = "";
            btn.textContent = "Delete";
            btn.classList.remove("manage-file-item__delete--confirm");
          }
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.textContent = "Deleting...";
      setManageStatus(imageDeleteStatus, "info", `Deleting ${filename}...`);
      try {
        const resp = await fetch(`/api/campaign-images/${encodeURIComponent(filename)}`, {
          method: "DELETE",
          headers: csrfHeaders(),
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok || payload.ok === false) {
          throw new Error(payload.message || "Unable to delete image.");
        }
        setManageStatus(imageDeleteStatus, "success", payload.message || `Deleted ${filename}.`);
        await loadImageList();
        await loadDiskUsage();
      } catch (err) {
        setManageStatus(imageDeleteStatus, "error", err.message || "Unable to delete image.");
        btn.disabled = false;
        btn.textContent = "Delete";
        btn.dataset.confirming = "";
        btn.classList.remove("manage-file-item__delete--confirm");
      }
    }

    /* ── campaign images: upload ──────────────────────────────── */

    if (imageUploadForm) {
      imageUploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!imageUploadForm.reportValidity()) return;

        const submitBtn = imageUploadForm.querySelector("button[type='submit']");
        if (submitBtn) submitBtn.disabled = true;
        setManageStatus(imageUploadStatus, "info", "Uploading...");

        try {
          const formData = new FormData(imageUploadForm);
          const resp = await fetch("/api/campaign-images/upload", {
            method: "POST",
            body: formData,
            headers: csrfHeaders({ Accept: "application/json" }),
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || "Upload failed.");
          }
          setManageStatus(imageUploadStatus, "success", payload.message || "Upload successful.");
          imageUploadForm.reset();
          await loadImageList();
          await loadDiskUsage();
        } catch (err) {
          setManageStatus(imageUploadStatus, "error", err.message || "Upload failed.");
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    /* ── manage modal: combined open handler ──────────────────── */

    function onManageModalOpen() {
      loadCampaignList();
      loadImageList();
      loadDiskUsage();
    }

    /* ── modal framework ─────────────────────────────────────── */

    const syncModalBodyState = () => {
      const anyOpen = document.querySelector(
        ".workflow-modal-backdrop:not([hidden])"
      );
      document.body.classList.toggle("modal-open", Boolean(anyOpen));
    };

    const setupModal = (backdrop, trigger, focusSelector, { onOpen, onClose } = {}) => {
      if (!backdrop || !trigger) return;
      const closeButtons = backdrop.querySelectorAll("[data-close-modal]");
      const focusTarget = focusSelector
        ? backdrop.querySelector(focusSelector)
        : null;
      const toggle = (shouldOpen) => {
        if (shouldOpen) {
          backdrop.removeAttribute("hidden");
          syncModalBodyState();
          if (onOpen) onOpen();
          requestAnimationFrame(() => focusTarget?.focus());
        } else {
          backdrop.setAttribute("hidden", "");
          syncModalBodyState();
          if (onClose) onClose();
        }
      };
      trigger.addEventListener("click", () => toggle(true));
      closeButtons.forEach((btn) =>
        btn.addEventListener("click", () => toggle(false))
      );
      backdrop.addEventListener("click", (event) => {
        if (event.target === backdrop) {
          toggle(false);
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !backdrop.hasAttribute("hidden")) {
          toggle(false);
        }
      });
    };

    setupModal(manageModal, manageTrigger, null, {
      onOpen: onManageModalOpen,
      onClose: closeFilePreview,
    });
    setupModal(adminModal, adminTrigger, null, {
      onOpen: loadAdminList,
    });

    /* ── file preview modal close handlers ────────────────────── */
    filePreviewModal.querySelectorAll("[data-close-modal]").forEach((btn) =>
      btn.addEventListener("click", closeFilePreview)
    );
    filePreviewModal.addEventListener("click", (event) => {
      if (event.target === filePreviewModal) closeFilePreview();
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !filePreviewModal.hasAttribute("hidden")) {
        closeFilePreview();
      }
    });

    /* ── preview / lint / test (unchanged logic) ─────────────── */

    function setLoading(isLoading) {
      reloadButton.textContent = isLoading ? "Loading..." : "Reload preview";
      reloadButton.disabled = isLoading || !select.value;
    }

    function updateLintStatus({ report = null, message = "" } = {}) {
      lintReport = report;
      lintStatusMessage = message;
      applyLintState();
    }

    function applyLintState() {
      const fileSelected = Boolean(select.value);
      const lintReady = lintReport !== null;
      const errors =
        lintReady && Array.isArray(lintReport.errors)
          ? lintReport.errors.length
          : 0;
      const warnings =
        lintReady && Array.isArray(lintReport.warnings)
          ? lintReport.warnings.length
          : 0;
      const hasErrors = errors > 0;
      const hasWarnings = warnings > 0;

      lintDependentControls.forEach((control) => {
        const shouldDisable = !fileSelected || !lintReady || hasErrors;
        control.disabled = shouldDisable;
      });

      lintStatusTargets.forEach((el) => {
        let text = "";
        let state = "";
        if (!fileSelected) {
          text = "Select a campaign to enable this action.";
        } else if (!lintReady) {
          text = lintStatusMessage || "Waiting for lint results...";
          state = "info";
        } else if (hasErrors) {
          state = "error";
          text =
            el.dataset.lintStatus === "test"
              ? "Fix lint errors before sending a test email."
              : "Fix lint errors before proceeding.";
        } else if (hasWarnings) {
          state = "warning";
          text = "Warnings detected. You may proceed but review carefully.";
        }

        if (text) {
          el.hidden = false;
          el.textContent = text;
          el.classList.toggle("lint-status--error", state === "error");
          el.classList.toggle("lint-status--warning", state === "warning");
          el.classList.toggle("lint-status--info", state === "info");
        } else {
          el.hidden = true;
          el.textContent = "";
          el.classList.remove(
            "lint-status--error",
            "lint-status--warning",
            "lint-status--info"
          );
        }
      });
    }

    function setTestStatus(state, message) {
      if (!testStatus) return;
      if (!message) {
        testStatus.hidden = true;
        testStatus.textContent = "";
        testStatus.classList.remove(
          "lint-status--error",
          "lint-status--warning",
          "lint-status--info"
        );
        return;
      }
      testStatus.hidden = false;
      testStatus.textContent = message;
      testStatus.classList.remove(
        "lint-status--error",
        "lint-status--warning",
        "lint-status--info"
      );
      if (state === "error") {
        testStatus.classList.add("lint-status--error");
      } else if (state === "warning") {
        testStatus.classList.add("lint-status--warning");
      } else {
        testStatus.classList.add("lint-status--info");
      }
    }

    function resetPreview() {
      if (controller) controller.abort();
      previewFrame.hidden = true;
      previewFrame.removeAttribute("srcdoc");
      previewPlaceholder.hidden = false;
      previewError.hidden = true;
      lintSection.hidden = true;
      lintContent.innerHTML = "";
      updateLintStatus({ report: null, message: "" });
      setTestStatus(null, "");
    }

    function renderLint(report) {
      lintContent.innerHTML = "";
      if (!report) {
        lintSection.hidden = true;
        return;
      }
      const keys = [
        { key: "errors", label: "Errors" },
        { key: "warnings", label: "Warnings" },
        { key: "notes", label: "Notes" },
      ];
      let hasContent = false;
      keys.forEach(({ key, label }) => {
        const items = Array.isArray(report[key]) ? report[key] : [];
        if (!items.length) {
          return;
        }
        hasContent = true;
        const heading = document.createElement("h4");
        heading.textContent = label;
        lintContent.appendChild(heading);
        const list = document.createElement("ul");
        items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          list.appendChild(li);
        });
        lintContent.appendChild(list);
      });
      if (!hasContent) {
        const p = document.createElement("p");
        p.textContent = "No lint issues found.";
        lintContent.appendChild(p);
      }
      lintSection.hidden = false;
    }

    async function loadPreview() {
      const file = select.value;
      if (!file) {
        resetPreview();
        return;
      }
      if (controller) controller.abort();
      controller = new AbortController();
      previewPlaceholder.hidden = true;
      previewError.hidden = true;
      setLoading(true);
      try {
        const resp = await fetch(`/preview?file=${encodeURIComponent(file)}`, {
          signal: controller.signal,
          headers: { Accept: "application/json" },
        });
        if (!resp.ok) {
          const payload = await resp.json().catch(() => ({}));
          throw new Error(payload.error || "Unable to load preview.");
        }
        const data = await resp.json();
        previewFrame.hidden = false;
        previewFrame.srcdoc = data.html || "";
        renderLint(data.lint);
        updateLintStatus({
          report: data.lint || { errors: [], warnings: [], notes: [] },
        });
      } catch (err) {
        if (err.name === "AbortError") return;
        previewFrame.hidden = true;
        previewPlaceholder.hidden = true;
        previewError.hidden = false;
        previewError.textContent = err.message || "Unable to load preview.";
        lintSection.hidden = true;
        updateLintStatus({
          report: null,
          message: err.message || "Lint unavailable.",
        });
      } finally {
        setLoading(false);
      }
    }

    select.addEventListener("change", () => {
      const file = select.value;
      syncInputs.forEach((input) => {
        input.value = file;
      });
      gatedControls.forEach((control) => {
        control.disabled = !file;
      });
      setTestStatus(null, "");
      if (file) {
        updateLintStatus({
          report: null,
          message: "Waiting for lint results...",
        });
        loadPreview();
      } else {
        resetPreview();
      }
    });

    reloadButton.addEventListener("click", () => {
      if (select.value) {
        loadPreview();
      }
    });

    if (testForm) {
      const submitButton = testForm.querySelector("button[type='submit']");
      testForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!testForm.reportValidity()) {
          return;
        }
        const previousDisabled = submitButton ? submitButton.disabled : false;
        if (submitButton) {
          submitButton.disabled = true;
        }
        setTestStatus("info", "Sending test email...");
        try {
          const formData = new FormData(testForm);
          const headers = {
            "X-Requested-With": "XMLHttpRequest",
            Accept: "application/json",
          };
          const csrfToken = window.getCsrfToken ? window.getCsrfToken() : "";
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }
          const resp = await fetch(testForm.action, {
            method: testForm.method,
            body: formData,
            headers,
          });
          const text = await resp.text();
          let payload = {};
          try {
            payload = JSON.parse(text);
          } catch (err) {
            payload = {};
          }
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || text || "Failed to send test email.");
          }
          setTestStatus("info", payload.message || "Test email sent.");
        } catch (err) {
          setTestStatus("error", err.message || "Failed to send test email.");
        } finally {
          if (submitButton) {
            submitButton.disabled = previousDisabled;
          }
          applyLintState();
        }
      });
    }

    updateLintStatus({ report: null, message: "" });

    /* ── Scheduler health indicator ───────────────────────────── */

    const schedulerDot = document.getElementById("schedulerDot");
    const schedulerLabel = document.getElementById("schedulerLabel");

    async function pollSchedulerHealth() {
      try {
        const resp = await fetch("/scheduler/health", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        if (data.alive) {
          schedulerDot.style.background = "#2ecc71";
          schedulerLabel.textContent = "Scheduler active";
        } else {
          schedulerDot.style.background = "#c0392b";
          schedulerLabel.textContent = "Scheduler down";
        }
      } catch {
        schedulerDot.style.background = "#888";
        schedulerLabel.textContent = "Scheduler: unknown";
      }
    }
    pollSchedulerHealth();
    setInterval(pollSchedulerHealth, 10000);

    /* ── Active send banner ───────────────────────────────────── */

    const activeSendBanner = document.getElementById("activeSendBanner");
    const activeSendFile = document.getElementById("activeSendFile");
    const activeSendProgress = document.getElementById("activeSendProgress");
    const activeSendLink = document.getElementById("activeSendLink");

    async function pollActiveSend() {
      try {
        const resp = await fetch("/api/active-send", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        if (data.send_id) {
          activeSendFile.textContent = data.campaign_file || "Campaign";
          const sent = data.sent_count || 0;
          const total = data.total_recipients || 0;
          activeSendProgress.textContent = ` — ${data.status} (${sent}/${total} sent)`;
          activeSendLink.href = `/send/${encodeURIComponent(data.send_id)}/status`;
          activeSendBanner.style.display = "";
        } else {
          activeSendBanner.style.display = "none";
        }
      } catch {
        activeSendBanner.style.display = "none";
      }
    }
    pollActiveSend();
    setInterval(pollActiveSend, 10000);
  })();
</script>

{% endblock %}
