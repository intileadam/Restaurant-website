{% extends 'base.html' %} {% block content %}
<section class="hero hero-utility">
  <div class="hero-copy">
    <p class="eyebrow">Workflow</p>
    <h2>Prepare and send campaigns</h2>
    <p>
      Follow the steps below in order. Each section unlocks once a campaign file
      is selected.
    </p>
    <p>
      Need a new template? Upload an HTML file below or drop it into
      <code>campaigns/</code> and refresh this page.
    </p>
    <button
      type="button"
      class="button outline hero-upload-button"
      id="openManageModal"
    >
      Manage campaigns
    </button>
  </div>
</section>

<div id="campaign-workflow" class="dashboard-grid">
  <section class="card focus-card preview-panel">
    <header class="card-header">
      <div>
        <p class="eyebrow">Step 1</p>
        <h2>Select a campaign</h2>
      </div>
      <span class="badge">Required</span>
    </header>
    <div class="focus-card__form">
      <label for="campaignSelect" class="field-label">Campaign file</label>
      <div class="field-control">
        <select id="campaignSelect">
          <option value="" selected>Select a campaign...</option>
          {% for f in campaign_files %}
          <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>
        <svg aria-hidden="true" viewBox="0 0 20 20">
          <path d="M6 8l4 4 4-4" />
        </svg>
      </div>
      <p class="help-text">
        Selecting a file automatically refreshes the preview and unlocks test
        and live send actions.
      </p>
    </div>
    <div class="focus-card__preview">
      <div class="preview-header">
        <h3>Email preview</h3>
        <button
          type="button"
          class="button ghost"
          id="reloadPreview"
          data-requires-selection
          disabled
        >
          Reload preview
        </button>
      </div>
      <div id="previewPlaceholder" class="preview-placeholder">
        Choose a campaign to render a fully responsive preview.
      </div>
      <iframe
        id="previewFrame"
        class="preview-frame"
        title="Email preview"
        hidden
      ></iframe>
      <div id="previewError" class="preview-error card muted" hidden></div>

      <section id="lintSection" class="lint card soft" hidden>
        <div class="lint-header">
          <h3>Lint report</h3>
          <span class="lint-chip">Auto generated</span>
        </div>
        <div id="lintContent"></div>
      </section>
    </div>
  </section>

  <div class="workflow-actions">
    <section class="card form-card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Step 2</p>
          <h2>Send a test</h2>
        </div>
      </header>
      <form method="post" action="/send-test" class="form-grid" id="testEmailForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="file" id="testFileInput" data-sync="file" />
        <label for="test_subject">Subject</label>
        <input
          type="text"
          id="test_subject"
          name="subject"
          placeholder="e.g., Weekend Specials"
          required
        />

        <label for="test_email">Send test to</label>
        <input
          type="email"
          id="test_email"
          name="email"
          placeholder="name@casadelpollo.com"
          required
        />

        <button
          type="submit"
          class="button primary full-width"
          data-requires-selection
          data-requires-clean-lint
          disabled
        >
          Send test email
        </button>
        <p class="lint-status" data-lint-status="test" hidden></p>
        <p
          id="testEmailStatus"
          class="lint-status form-status"
          aria-live="polite"
          hidden
        ></p>
      </form>
    </section>

    <section class="card form-card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Step 3</p>
          <h2>Live send</h2>
        </div>
      </header>
      <form method="get" action="/confirm" class="form-grid">
        <input type="hidden" name="file" id="sendFileInput" data-sync="file" />

        <label for="subject2">Subject</label>
        <input
          type="text"
          id="subject2"
          name="subject"
          placeholder="Subject line for customers"
          required
        />

        <button
          type="submit"
          class="button accent full-width"
          data-requires-selection
          data-requires-clean-lint
          disabled
        >
          Review &amp; confirm
        </button>
        <p class="lint-status" data-lint-status="live" hidden></p>
      </form>
    </section>
  </div>

</div>

<div class="workflow-modal-backdrop" id="userModal" hidden>
  <div
    class="workflow-modal card user-card"
    role="dialog"
    aria-modal="true"
    aria-labelledby="userModalTitle"
  >
    <button
      type="button"
      class="workflow-modal__close"
      data-close-modal
      aria-label="Close add user dialog"
    >
      &times;
    </button>
    <header class="card-header">
      <div>
        <p class="eyebrow">Team access</p>
        <h2 id="userModalTitle">Add admin</h2>
      </div>
      <span class="badge">Admins only</span>
    </header>
    <p class="user-card__lead">
      Keep this console restricted to trusted staff. New accounts can sign in immediately after
      being added.
    </p>
    <form method="post" action="{{ url_for('add_operator') }}" class="form-grid user-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <label for="operator_email">Email address</label>
      <input
        type="email"
        id="operator_email"
        name="operator_email"
        placeholder="name@casadelpollo.com"
        required
      />

      <label for="operator_password">Password</label>
      <input
        type="password"
        id="operator_password"
        name="operator_password"
        minlength="{{ min_password_length }}"
        placeholder="Minimum {{ min_password_length }} characters"
        required
      />

      <label for="operator_password_confirm">Confirm password</label>
      <input
        type="password"
        id="operator_password_confirm"
        name="operator_password_confirm"
        minlength="{{ min_password_length }}"
        required
      />

      <button type="submit" class="button primary full-width">
        Save user
      </button>
    </form>
  </div>
</div>

<div class="workflow-modal-backdrop" id="manageModal" hidden>
  <div
    class="workflow-modal card manage-card"
    role="dialog"
    aria-modal="true"
    aria-labelledby="manageModalTitle"
  >
    <button
      type="button"
      class="workflow-modal__close"
      data-close-modal
      aria-label="Close manage campaigns dialog"
    >
      &times;
    </button>
    <header class="card-header">
      <div>
        <h2 id="manageModalTitle">Manage campaigns</h2>
      </div>
    </header>

    <section class="manage-section">
      <h3 class="manage-section__title">Campaign files</h3>
      <p class="manage-section__lead">
        Files stored in <code>campaigns/</code>. Delete any file you no longer need.
      </p>
      <div id="manageFileList" class="manage-file-list">
        <p class="manage-file-list__loading">Loading...</p>
      </div>
      <p
        id="manageDeleteStatus"
        class="manage-status"
        aria-live="polite"
        hidden
      ></p>
    </section>

    <hr class="manage-divider" />

    <section class="manage-section">
      <h3 class="manage-section__title">Upload new file</h3>
      <form
        id="manageUploadForm"
        class="upload-card__form form-grid"
        enctype="multipart/form-data"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <label for="campaign_file">HTML file</label>
        <input
          type="file"
          id="campaign_file"
          name="campaign_file"
          accept=".html,text/html"
          required
        />

        <label for="campaign_filename">Save as (optional)</label>
        <input
          type="text"
          id="campaign_filename"
          name="filename"
          placeholder="my-email.html"
          inputmode="text"
        />

        <button type="submit" class="button secondary full-width">
          Upload HTML
        </button>
        <p
          id="manageUploadStatus"
          class="manage-status"
          aria-live="polite"
          hidden
        ></p>
      </form>
    </section>
  </div>
</div>

<script>
  (() => {
    const manageModal = document.getElementById("manageModal");
    const manageTrigger = document.getElementById("openManageModal");
    const userModal = document.getElementById("userModal");
    const userTrigger = document.querySelector("[data-open-user-modal]");
    const select = document.getElementById("campaignSelect");
    const previewFrame = document.getElementById("previewFrame");
    const previewPlaceholder = document.getElementById("previewPlaceholder");
    const previewError = document.getElementById("previewError");
    const reloadButton = document.getElementById("reloadPreview");
    const lintSection = document.getElementById("lintSection");
    const lintContent = document.getElementById("lintContent");
    const syncInputs = document.querySelectorAll("[data-sync='file']");
    const gatedControls = document.querySelectorAll(
      "[data-requires-selection]"
    );
    const lintDependentControls = document.querySelectorAll(
      "[data-requires-clean-lint]"
    );
    const lintStatusTargets = document.querySelectorAll("[data-lint-status]");
    const testForm = document.getElementById("testEmailForm");
    const testStatus = document.getElementById("testEmailStatus");

    const manageFileList = document.getElementById("manageFileList");
    const manageUploadForm = document.getElementById("manageUploadForm");
    const manageUploadStatus = document.getElementById("manageUploadStatus");
    const manageDeleteStatus = document.getElementById("manageDeleteStatus");

    let controller = null;
    let lintReport = null;
    let lintStatusMessage = "";

    /* ── helpers ─────────────────────────────────────────────── */

    function csrfHeaders(extra = {}) {
      const headers = { "X-Requested-With": "XMLHttpRequest", Accept: "application/json", ...extra };
      const token = window.getCsrfToken ? window.getCsrfToken() : "";
      if (token) headers["X-CSRF-Token"] = token;
      return headers;
    }

    function setManageStatus(el, state, message) {
      if (!el) return;
      if (!message) {
        el.hidden = true;
        el.textContent = "";
        el.className = "manage-status";
        return;
      }
      el.hidden = false;
      el.textContent = message;
      el.className = "manage-status";
      if (state === "error") el.classList.add("manage-status--error");
      else if (state === "success") el.classList.add("manage-status--success");
      else el.classList.add("manage-status--info");
    }

    /* ── campaign select sync ────────────────────────────────── */

    function syncSelectOptions(files) {
      const previousValue = select.value;
      const placeholder = select.querySelector("option[value='']");
      select.innerHTML = "";
      if (placeholder) {
        select.appendChild(placeholder);
      } else {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select a campaign...";
        select.appendChild(opt);
      }
      files.forEach((f) => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        select.appendChild(opt);
      });
      if (files.includes(previousValue)) {
        select.value = previousValue;
      } else {
        select.value = "";
        select.dispatchEvent(new Event("change"));
      }
    }

    /* ── manage modal: file list ─────────────────────────────── */

    async function loadCampaignList() {
      manageFileList.innerHTML = '<p class="manage-file-list__loading">Loading...</p>';
      setManageStatus(manageDeleteStatus, null, "");
      try {
        const resp = await fetch("/api/campaigns", { headers: csrfHeaders() });
        if (!resp.ok) throw new Error("Unable to load campaign list.");
        const files = await resp.json();
        renderFileList(files);
        syncSelectOptions(files);
      } catch (err) {
        manageFileList.innerHTML = "";
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = err.message || "Unable to load files.";
        manageFileList.appendChild(p);
      }
    }

    function renderFileList(files) {
      manageFileList.innerHTML = "";
      if (!files.length) {
        const p = document.createElement("p");
        p.className = "manage-file-list__empty";
        p.textContent = "No campaign files found.";
        manageFileList.appendChild(p);
        return;
      }
      files.forEach((filename) => {
        const row = document.createElement("div");
        row.className = "manage-file-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "manage-file-item__name";
        nameSpan.textContent = filename;
        row.appendChild(nameSpan);

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "button manage-file-item__delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => handleDelete(filename, deleteBtn));
        row.appendChild(deleteBtn);

        manageFileList.appendChild(row);
      });
    }

    async function handleDelete(filename, btn) {
      if (btn.dataset.confirming !== "true") {
        btn.dataset.confirming = "true";
        btn.textContent = "Confirm?";
        btn.classList.add("manage-file-item__delete--confirm");
        setTimeout(() => {
          if (btn.dataset.confirming === "true") {
            btn.dataset.confirming = "";
            btn.textContent = "Delete";
            btn.classList.remove("manage-file-item__delete--confirm");
          }
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.textContent = "Deleting...";
      setManageStatus(manageDeleteStatus, "info", `Deleting ${filename}...`);
      try {
        const resp = await fetch(`/api/campaigns/${encodeURIComponent(filename)}`, {
          method: "DELETE",
          headers: csrfHeaders(),
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok || payload.ok === false) {
          throw new Error(payload.message || "Unable to delete file.");
        }
        setManageStatus(manageDeleteStatus, "success", payload.message || `Deleted ${filename}.`);
        await loadCampaignList();
      } catch (err) {
        setManageStatus(manageDeleteStatus, "error", err.message || "Unable to delete file.");
        btn.disabled = false;
        btn.textContent = "Delete";
        btn.dataset.confirming = "";
        btn.classList.remove("manage-file-item__delete--confirm");
      }
    }

    /* ── manage modal: upload ────────────────────────────────── */

    if (manageUploadForm) {
      manageUploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!manageUploadForm.reportValidity()) return;

        const submitBtn = manageUploadForm.querySelector("button[type='submit']");
        if (submitBtn) submitBtn.disabled = true;
        setManageStatus(manageUploadStatus, "info", "Uploading...");

        try {
          const formData = new FormData(manageUploadForm);
          const resp = await fetch("{{ url_for('upload_campaign') }}", {
            method: "POST",
            body: formData,
            headers: csrfHeaders({ Accept: "application/json" }),
          });
          const payload = await resp.json().catch(() => ({}));
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || "Upload failed.");
          }
          setManageStatus(manageUploadStatus, "success", payload.message || "Upload successful.");
          manageUploadForm.reset();
          await loadCampaignList();
        } catch (err) {
          setManageStatus(manageUploadStatus, "error", err.message || "Upload failed.");
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    /* ── modal framework ─────────────────────────────────────── */

    const syncModalBodyState = () => {
      const anyOpen = document.querySelector(
        ".workflow-modal-backdrop:not([hidden])"
      );
      document.body.classList.toggle("modal-open", Boolean(anyOpen));
    };

    const setupModal = (backdrop, trigger, focusSelector, { onOpen } = {}) => {
      if (!backdrop || !trigger) return;
      const closeButtons = backdrop.querySelectorAll("[data-close-modal]");
      const focusTarget = focusSelector
        ? backdrop.querySelector(focusSelector)
        : null;
      const toggle = (shouldOpen) => {
        if (shouldOpen) {
          backdrop.removeAttribute("hidden");
          syncModalBodyState();
          if (onOpen) onOpen();
          requestAnimationFrame(() => focusTarget?.focus());
        } else {
          backdrop.setAttribute("hidden", "");
          syncModalBodyState();
        }
      };
      trigger.addEventListener("click", () => toggle(true));
      closeButtons.forEach((btn) =>
        btn.addEventListener("click", () => toggle(false))
      );
      backdrop.addEventListener("click", (event) => {
        if (event.target === backdrop) {
          toggle(false);
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !backdrop.hasAttribute("hidden")) {
          toggle(false);
        }
      });
    };

    setupModal(manageModal, manageTrigger, null, { onOpen: loadCampaignList });
    setupModal(userModal, userTrigger, "#operator_email");

    /* ── preview / lint / test (unchanged logic) ─────────────── */

    function setLoading(isLoading) {
      reloadButton.textContent = isLoading ? "Loading..." : "Reload preview";
      reloadButton.disabled = isLoading || !select.value;
    }

    function updateLintStatus({ report = null, message = "" } = {}) {
      lintReport = report;
      lintStatusMessage = message;
      applyLintState();
    }

    function applyLintState() {
      const fileSelected = Boolean(select.value);
      const lintReady = lintReport !== null;
      const errors =
        lintReady && Array.isArray(lintReport.errors)
          ? lintReport.errors.length
          : 0;
      const warnings =
        lintReady && Array.isArray(lintReport.warnings)
          ? lintReport.warnings.length
          : 0;
      const hasErrors = errors > 0;
      const hasWarnings = warnings > 0;

      lintDependentControls.forEach((control) => {
        const shouldDisable = !fileSelected || !lintReady || hasErrors;
        control.disabled = shouldDisable;
      });

      lintStatusTargets.forEach((el) => {
        let text = "";
        let state = "";
        if (!fileSelected) {
          text = "Select a campaign to enable this action.";
        } else if (!lintReady) {
          text = lintStatusMessage || "Waiting for lint results...";
          state = "info";
        } else if (hasErrors) {
          state = "error";
          text =
            el.dataset.lintStatus === "test"
              ? "Fix lint errors before sending a test email."
              : "Fix lint errors before proceeding.";
        } else if (hasWarnings) {
          state = "warning";
          text = "Warnings detected. You may proceed but review carefully.";
        }

        if (text) {
          el.hidden = false;
          el.textContent = text;
          el.classList.toggle("lint-status--error", state === "error");
          el.classList.toggle("lint-status--warning", state === "warning");
          el.classList.toggle("lint-status--info", state === "info");
        } else {
          el.hidden = true;
          el.textContent = "";
          el.classList.remove(
            "lint-status--error",
            "lint-status--warning",
            "lint-status--info"
          );
        }
      });
    }

    function setTestStatus(state, message) {
      if (!testStatus) return;
      if (!message) {
        testStatus.hidden = true;
        testStatus.textContent = "";
        testStatus.classList.remove(
          "lint-status--error",
          "lint-status--warning",
          "lint-status--info"
        );
        return;
      }
      testStatus.hidden = false;
      testStatus.textContent = message;
      testStatus.classList.remove(
        "lint-status--error",
        "lint-status--warning",
        "lint-status--info"
      );
      if (state === "error") {
        testStatus.classList.add("lint-status--error");
      } else if (state === "warning") {
        testStatus.classList.add("lint-status--warning");
      } else {
        testStatus.classList.add("lint-status--info");
      }
    }

    function resetPreview() {
      if (controller) controller.abort();
      previewFrame.hidden = true;
      previewFrame.removeAttribute("srcdoc");
      previewPlaceholder.hidden = false;
      previewError.hidden = true;
      lintSection.hidden = true;
      lintContent.innerHTML = "";
      updateLintStatus({ report: null, message: "" });
      setTestStatus(null, "");
    }

    function renderLint(report) {
      lintContent.innerHTML = "";
      if (!report) {
        lintSection.hidden = true;
        return;
      }
      const keys = [
        { key: "errors", label: "Errors" },
        { key: "warnings", label: "Warnings" },
        { key: "notes", label: "Notes" },
      ];
      let hasContent = false;
      keys.forEach(({ key, label }) => {
        const items = Array.isArray(report[key]) ? report[key] : [];
        if (!items.length) {
          return;
        }
        hasContent = true;
        const heading = document.createElement("h4");
        heading.textContent = label;
        lintContent.appendChild(heading);
        const list = document.createElement("ul");
        items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          list.appendChild(li);
        });
        lintContent.appendChild(list);
      });
      if (!hasContent) {
        const p = document.createElement("p");
        p.textContent = "No lint issues found.";
        lintContent.appendChild(p);
      }
      lintSection.hidden = false;
    }

    async function loadPreview() {
      const file = select.value;
      if (!file) {
        resetPreview();
        return;
      }
      if (controller) controller.abort();
      controller = new AbortController();
      previewPlaceholder.hidden = true;
      previewError.hidden = true;
      setLoading(true);
      try {
        const resp = await fetch(`/preview?file=${encodeURIComponent(file)}`, {
          signal: controller.signal,
          headers: { Accept: "application/json" },
        });
        if (!resp.ok) {
          const payload = await resp.json().catch(() => ({}));
          throw new Error(payload.error || "Unable to load preview.");
        }
        const data = await resp.json();
        previewFrame.hidden = false;
        previewFrame.srcdoc = data.html || "";
        renderLint(data.lint);
        updateLintStatus({
          report: data.lint || { errors: [], warnings: [], notes: [] },
        });
      } catch (err) {
        if (err.name === "AbortError") return;
        previewFrame.hidden = true;
        previewPlaceholder.hidden = true;
        previewError.hidden = false;
        previewError.textContent = err.message || "Unable to load preview.";
        lintSection.hidden = true;
        updateLintStatus({
          report: null,
          message: err.message || "Lint unavailable.",
        });
      } finally {
        setLoading(false);
      }
    }

    select.addEventListener("change", () => {
      const file = select.value;
      syncInputs.forEach((input) => {
        input.value = file;
      });
      gatedControls.forEach((control) => {
        control.disabled = !file;
      });
      setTestStatus(null, "");
      if (file) {
        updateLintStatus({
          report: null,
          message: "Waiting for lint results...",
        });
        loadPreview();
      } else {
        resetPreview();
      }
    });

    reloadButton.addEventListener("click", () => {
      if (select.value) {
        loadPreview();
      }
    });

    if (testForm) {
      const submitButton = testForm.querySelector("button[type='submit']");
      testForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!testForm.reportValidity()) {
          return;
        }
        const previousDisabled = submitButton ? submitButton.disabled : false;
        if (submitButton) {
          submitButton.disabled = true;
        }
        setTestStatus("info", "Sending test email...");
        try {
          const formData = new FormData(testForm);
          const headers = {
            "X-Requested-With": "XMLHttpRequest",
            Accept: "application/json",
          };
          const csrfToken = window.getCsrfToken ? window.getCsrfToken() : "";
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }
          const resp = await fetch(testForm.action, {
            method: testForm.method,
            body: formData,
            headers,
          });
          const text = await resp.text();
          let payload = {};
          try {
            payload = JSON.parse(text);
          } catch (err) {
            payload = {};
          }
          if (!resp.ok || payload.ok === false) {
            throw new Error(payload.message || text || "Failed to send test email.");
          }
          setTestStatus("info", payload.message || "Test email sent.");
        } catch (err) {
          setTestStatus("error", err.message || "Failed to send test email.");
        } finally {
          if (submitButton) {
            submitButton.disabled = previousDisabled;
          }
          applyLintState();
        }
      });
    }

    updateLintStatus({ report: null, message: "" });
  })();
</script>

{% endblock %}
