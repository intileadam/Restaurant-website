<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>Casa del Pollo — Emailer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='favicon.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <script>
      window.getCsrfToken = function () {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute("content") || "" : "";
      };
    </script>
  </head>
  <body
    class="theme{% if current_db_mode == 'test' %} theme--test{% endif %}"
    data-db-mode="{{ current_db_mode }}"
  >
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <img
            src="{{ url_for('static', filename='logo.png') }}"
            alt="Casa del Pollo"
            class="brand-mark"
          />
          <div class="brand-copy">
            <h1>Campaign Console</h1>
          </div>
        </div>
        <div class="header-actions">
          {% set campaigns_endpoints = ["index", "campaign_history_detail"] %}
          {% set queue_endpoints = ["queue_campaign", "confirm"] %}
          {% set customer_endpoints = ["new_customer"] %}
          <nav class="primary-nav">
            <a
              href="{{ url_for('index') }}"
              class="nav-link{% if request.endpoint in campaigns_endpoints %} nav-link--active{% endif %}"
            >
              Campaigns
            </a>
            <a
              href="{{ url_for('queue_campaign') }}"
              class="nav-link{% if request.endpoint in queue_endpoints %} nav-link--active{% endif %}"
            >
              Queue campaign
            </a>
            <a
              href="{{ url_for('new_customer') }}"
              class="nav-link{% if request.endpoint in customer_endpoints %} nav-link--active{% endif %}"
            >
              Customers
            </a>
          </nav>
          {% if g.user %}
          <div
            class="header-mode"
            id="headerModeToggle"
            data-active-mode="{{ current_db_mode }}"
          >
            <span class="header-mode__label">DB</span>
            <div class="header-mode__buttons" role="group" aria-label="Database mode">
              <button
                type="button"
                class="header-mode__button {% if current_db_mode != 'test' %}is-active{% endif %}"
                data-mode="production"
                {% if current_db_mode != 'test' %}disabled{% endif %}
              >
                Prod
              </button>
              <button
                type="button"
                class="header-mode__button {% if current_db_mode == 'test' %}is-active{% endif %}"
                data-mode="test"
                {% if current_db_mode == 'test' %}disabled{% endif %}
              >
                Test
              </button>
            </div>
            <span class="header-mode__status" id="headerModeStatus" aria-live="polite">
              {% if current_db_mode == 'test' %}Test mode{% else %}Production mode{% endif %}
            </span>
          </div>
          {% endif %}
          {% if g.user %}
          <button
            type="button"
            class="header-add-user"
            data-open-admin-modal
          >
            Manage admins
          </button>
          {% endif %}
          {% if g.user %}
          <div class="session-controls">
            <span class="session-user">Signed in as {{ g.user.username }}</span>
            <a href="{{ url_for('logout') }}" class="nav-link nav-link--ghost">Sign out</a>
          </div>
          {% endif %}
        </div>
      </header>

      {% with flashes = get_flashed_messages(with_categories=True) %} {% if
      flashes %}
      <section class="flash-stack">
        {% for category, message in flashes %}
        <div class="flash flash-{{ category }}">
          <span>{{ message }}</span>
          <button type="button" class="flash-dismiss" aria-label="Dismiss">
            &times;
          </button>
        </div>
        {% endfor %}
      </section>
      {% endif %} {% endwith %}

      <main class="app-main{% block app_main_class %}{% endblock %}">
        {% block content %}{% endblock %}
      </main>

      {% if g.user %}
      <div class="workflow-modal-backdrop" id="adminModal" hidden>
        <div
          class="workflow-modal card admin-card"
          role="dialog"
          aria-modal="true"
          aria-labelledby="adminModalTitle"
        >
          <button
            type="button"
            class="workflow-modal__close"
            data-close-modal
            aria-label="Close manage admins dialog"
          >
            &times;
          </button>
          <header class="card-header">
            <div>
              <p class="eyebrow">Team access</p>
              <h2 id="adminModalTitle">Manage admins</h2>
            </div>
            <span class="badge">Admins only</span>
          </header>

          <section class="manage-section">
            <h3 class="manage-section__title">Current admins</h3>
            <div id="adminUserList" class="admin-user-list">
              <p class="admin-user-list__loading">Loading...</p>
            </div>
          </section>

          <hr class="manage-divider" />

          <section class="manage-section">
            <h3 class="manage-section__title">Add new admin</h3>
            <p class="manage-section__lead">
              New accounts can sign in immediately after being added.
            </p>
            <form method="post" action="{{ url_for('add_operator') }}" class="form-grid user-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <label for="operator_email">Email address</label>
              <input
                type="email"
                id="operator_email"
                name="operator_email"
                placeholder="name@casadelpollo.com"
                required
              />

              <label for="operator_password">Password</label>
              <input
                type="password"
                id="operator_password"
                name="operator_password"
                minlength="{{ min_password_length }}"
                placeholder="Minimum {{ min_password_length }} characters"
                required
              />

              <label for="operator_password_confirm">Confirm password</label>
              <input
                type="password"
                id="operator_password_confirm"
                name="operator_password_confirm"
                minlength="{{ min_password_length }}"
                required
              />

              <button type="submit" class="button primary full-width">
                Add admin
              </button>
            </form>
          </section>

          <hr class="manage-divider" />

          <section class="manage-section">
            <h3 class="manage-section__title">Change your password</h3>
            <p class="manage-section__lead">
              Update the password for <strong>{{ g.user.username }}</strong>.
            </p>
            <form method="post" action="{{ url_for('change_own_password') }}" class="form-grid user-form" id="changePasswordForm">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

              <label for="current_password">Current password</label>
              <input
                type="password"
                id="current_password"
                name="current_password"
                required
              />

              <label for="new_password">New password</label>
              <input
                type="password"
                id="new_password"
                name="new_password"
                minlength="{{ min_password_length }}"
                placeholder="Minimum {{ min_password_length }} characters"
                required
              />

              <label for="new_password_confirm">Confirm new password</label>
              <input
                type="password"
                id="new_password_confirm"
                name="new_password_confirm"
                minlength="{{ min_password_length }}"
                required
              />

              <button type="submit" class="button primary full-width">
                Change password
              </button>
            </form>
          </section>
        </div>
      </div>
      {% endif %}
    </div>
    <script>
      document.addEventListener("click", (event) => {
        if (event.target.matches(".flash-dismiss")) {
          event.target.closest(".flash").remove();
        }
      });
      (function () {
        const adminModal = document.getElementById("adminModal");
        const adminTrigger = document.querySelector("[data-open-admin-modal]");
        const adminUserList = document.getElementById("adminUserList");
        if (adminModal && adminTrigger) {
          function csrfHeaders(extra) {
            const headers = { "X-Requested-With": "XMLHttpRequest", Accept: "application/json", ...(extra || {}) };
            const token = window.getCsrfToken ? window.getCsrfToken() : "";
            if (token) headers["X-CSRF-Token"] = token;
            return headers;
          }
          async function loadAdminList() {
            if (!adminUserList) return;
            adminUserList.innerHTML = "<p class=\"admin-user-list__loading\">Loading...</p>";
            try {
              const resp = await fetch("/users", { headers: csrfHeaders() });
              if (!resp.ok) throw new Error("Unable to load admin list.");
              const data = await resp.json();
              const users = data.users || [];
              adminUserList.innerHTML = "";
              if (!users.length) {
                const p = document.createElement("p");
                p.className = "admin-user-list__empty";
                p.textContent = "No admin accounts found.";
                adminUserList.appendChild(p);
                return;
              }
              const table = document.createElement("table");
              table.className = "admin-table";
              const thead = document.createElement("thead");
              thead.innerHTML = "<tr><th>Email</th><th>Role</th><th>Status</th><th>Last login</th></tr>";
              table.appendChild(thead);
              const tbody = document.createElement("tbody");
              users.forEach(function (u) {
                const tr = document.createElement("tr");
                const emailTd = document.createElement("td");
                emailTd.textContent = u.username;
                const roleTd = document.createElement("td");
                roleTd.textContent = u.role || "admin";
                const statusTd = document.createElement("td");
                statusTd.textContent = u.is_active ? "Active" : "Inactive";
                statusTd.className = u.is_active ? "status-active" : "status-inactive";
                const loginTd = document.createElement("td");
                if (u.last_login_at) {
                  const d = new Date(u.last_login_at);
                  loginTd.textContent = d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
                } else {
                  loginTd.textContent = "Never";
                  loginTd.className = "text-muted";
                }
                tr.appendChild(emailTd);
                tr.appendChild(roleTd);
                tr.appendChild(statusTd);
                tr.appendChild(loginTd);
                tbody.appendChild(tr);
              });
              table.appendChild(tbody);
              adminUserList.appendChild(table);
            } catch (err) {
              adminUserList.innerHTML = "";
              const p = document.createElement("p");
              p.className = "admin-user-list__empty";
              p.textContent = err.message || "Unable to load admins.";
              adminUserList.appendChild(p);
            }
          }
          const syncModalBodyState = function () {
            const anyOpen = document.querySelector(".workflow-modal-backdrop:not([hidden])");
            document.body.classList.toggle("modal-open", Boolean(anyOpen));
          };
          const toggle = function (shouldOpen) {
            if (shouldOpen) {
              adminModal.removeAttribute("hidden");
              syncModalBodyState();
              loadAdminList();
              requestAnimationFrame(function () { adminModal.querySelector("[data-close-modal]")?.focus(); });
            } else {
              adminModal.setAttribute("hidden", "");
              syncModalBodyState();
            }
          };
          adminTrigger.addEventListener("click", function () { toggle(true); });
          adminModal.querySelectorAll("[data-close-modal]").forEach(function (btn) {
            btn.addEventListener("click", function () { toggle(false); });
          });
          adminModal.addEventListener("click", function (event) {
            if (event.target === adminModal) toggle(false);
          });
          document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && !adminModal.hasAttribute("hidden")) toggle(false);
          });
        }
      })();
      (function () {
        const body = document.body;
        const toggle = document.getElementById("headerModeToggle");
        if (!body || !toggle) return;
        const buttons = toggle.querySelectorAll("[data-mode]");
        const status = document.getElementById("headerModeStatus");
        let activeMode = toggle.dataset.activeMode || body.dataset.dbMode || "production";
        let requestInFlight = false;

        const normalizeMode = (mode) => (mode === "test" ? "test" : "production");

        const applyBodyMode = (mode) => {
          const normalized = normalizeMode(mode);
          body.dataset.dbMode = normalized;
          body.classList.toggle("theme--test", normalized === "test");
        };

        const syncButtonDisabled = () => {
          buttons.forEach((btn) => {
            const isActive = btn.dataset.mode === activeMode;
            btn.disabled = isActive || requestInFlight;
          });
        };

        const setModeUI = (mode) => {
          const normalized = normalizeMode(mode);
          activeMode = normalized;
          toggle.dataset.activeMode = normalized;
          buttons.forEach((btn) => {
            const isActive = btn.dataset.mode === normalized;
            btn.classList.toggle("is-active", isActive);
          });
          if (status) {
            status.textContent = normalized === "test" ? "Test mode" : "Production mode";
            status.classList.toggle("header-mode__status--error", false);
          }
          applyBodyMode(normalized);
          syncButtonDisabled();
        };

        const setStatusMessage = (message, { isError = false, temporary = false } = {}) => {
          if (!status) return;
          status.textContent = message;
          status.classList.toggle("header-mode__status--error", isError);
          if (temporary) {
            clearTimeout(setStatusMessage._timeout);
            setStatusMessage._timeout = setTimeout(() => {
              status.textContent = activeMode === "test" ? "Test mode" : "Production mode";
              status.classList.remove("header-mode__status--error");
            }, 2500);
          }
        };

        const updateMode = async (targetMode) => {
          const normalized = normalizeMode(targetMode);
          if (normalized === activeMode || requestInFlight) {
            return;
          }
          requestInFlight = true;
          syncButtonDisabled();
          setStatusMessage("Switching…");
          try {
            const headers = {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
              Accept: "application/json",
            };
            const csrfToken = window.getCsrfToken ? window.getCsrfToken() : "";
            if (csrfToken) {
              headers["X-CSRF-Token"] = csrfToken;
            }
            const resp = await fetch("/mode", {
              method: "POST",
              headers,
              body: JSON.stringify({ mode: normalized }),
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok || payload.ok === false) {
              throw new Error(payload.message || "Unable to update mode.");
            }
            const appliedMode = normalizeMode(payload.mode || normalized);
            setModeUI(appliedMode);
            window.dispatchEvent(
              new CustomEvent("db-mode-changed", { detail: { mode: appliedMode } })
            );
            setStatusMessage(
              appliedMode === "test" ? "Test mode" : "Production mode",
              { temporary: true }
            );
          } catch (err) {
            setStatusMessage(err.message || "Unable to update mode.", {
              isError: true,
              temporary: true,
            });
          } finally {
            requestInFlight = false;
            syncButtonDisabled();
          }
        };

        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.dataset.mode;
            if (target) {
              updateMode(target);
            }
          });
        });

        setModeUI(activeMode);
      })();
    </script>
  </body>
</html>
